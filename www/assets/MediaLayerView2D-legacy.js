System.register(["./index-legacy.js","./perspectiveUtils-legacy.js","./GeometryUtils-legacy.js","./UpdateTracking2D-legacy.js","./enums-legacy2.js","./definitions-legacy.js","./floatRGBA-legacy.js","./Container-legacy.js","./WGLContainer-legacy.js","./Texture-legacy.js","./enums-legacy.js","./Program-legacy.js","./LabelMetric-legacy.js","./StyleDefinition-legacy.js","./enums-legacy3.js","./MagnifierPrograms-legacy.js","./pbf-legacy.js","./FeatureCommandQueue-legacy.js","./OrderIndependentTransparency-legacy.js","./testSVGPremultipliedAlpha-legacy.js","./GraphicsView2D-legacy.js","./earcut-legacy.js","./vec3f32-legacy.js","./mat3f64-legacy.js","./utils-legacy2.js","./ProgramTemplate-legacy.js","./LayerView-legacy.js","./normalizeUtilsSync-legacy.js","./TurboLine-legacy.js","./OptimizedGeometry-legacy.js","./Rect-legacy.js","./BindType-legacy.js","./Util-legacy.js","./highlightReasons-legacy.js","./constants-legacy.js","./VertexElementDescriptor-legacy.js","./config-legacy.js","./featureConversionUtils-legacy.js","./OptimizedFeatureSet-legacy.js","./CircularArray-legacy.js","./AttributeStore-legacy.js","./TimeOnly-legacy.js","./timeSupport-legacy.js","./json-legacy.js","./basicInterfaces-legacy.js"],(function(e,t){"use strict";var s,i,r,n,l,a,o,c,h,u,d,m,y,p,g,f,_,v,w,j,R,x,T,M,V,S,b,E,C,A,G,q,D,O,P,U,H,L,z,I,W,Q,k,B,F,N,J,K,Y,X,Z;return{setters:[e=>{s=e.g5,i=e.C,r=e.P,n=e.g6,l=e.B,a=e.g7,o=e.w,c=e.s,h=e.eW,u=e.g8,d=e.eQ,m=e.g9,y=e.eJ,p=e.eO,g=e.eK,f=e.eL,_=e.ga,v=e.eM,w=e.aa,j=e.gb,R=e.V,x=e.R,T=e.m,M=e.r,V=e.gc,S=e.o,b=e.aQ,E=e.e7,C=e.x,A=e.y,G=e.z,q=e.a9,D=e.gd},e=>{O=e.j,P=e.m},null,null,e=>{U=e.d},null,null,e=>{H=e.i,L=e.E},e=>{z=e.n,I=e.h},e=>{W=e.e,Q=e.m},e=>{k=e.D,B=e.F},e=>{F=e.h},null,null,null,null,null,null,null,null,null,null,e=>{N=e.r},e=>{J=e.e},e=>{K=e.f},e=>{Y=e.o},e=>{X=e.m,Z=e.u},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){const t=J(),$={none:U.None,loop:U.Loop,oscillate:U.Oscillate};class ee extends H{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=s(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(i((()=>this.elementView.element.opacity),(e=>this.opacity=e),r),i((()=>[this.elementView.coords]),(()=>{this.requestRender()}),r),i((()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions]),(()=>{this._playHandle?.remove(),this.texture=n(this.texture),this.requestRender()}),r),l((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&null!=e.content&&this._handles.push(a(e.content,"play",(()=>this.requestRender())))}),r)),e.element.load().catch((t=>{o.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new c("element-load-error","Element cannot be displayed",{element:e,error:t}))}))}getMesh(e){throw new Error("Method not implemented.")}destroy(){this._playHandle?.remove(),this._handles.forEach((e=>e.remove())),this.texture=n(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,s=this.elementView.element.content;if(null!=s){const e=s instanceof HTMLImageElement,i=s instanceof HTMLVideoElement,r=e?s.naturalWidth:i?s.videoWidth:s.width,n=e?s.naturalHeight:i?s.videoHeight:s.height;if(this._updatePerspectiveTransform(r,n),this.texture)i&&!s.paused&&(this.texture.setData(s),this.requestRender(),this.texture.generateMipmap());else{const e=new W;if(e.wrapMode=k.CLAMP_TO_EDGE,e.preMultiplyAlpha=!0,e.width=r,e.height=n,"getFrame"in s){const i=s=>{this.texture?this.texture.setData(s):this.texture=new Q(t,e,s),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=K(s,function(e){return e?{...e,playAnimation:e.playing,repeatType:e.repeatType?$[e.repeatType]:void 0}:{}}(this.elementView.element.animationOptions),null,i))}else this.texture=new Q(t,e,s);this.texture.generateMipmap(),i&&!s.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const s=this.elementView.coords;if(null==s)return;const[i,r,n,l]=s.rings[0],a=this._vertices,{x:o,y:c}=e,h=0!==t;h?a.set([r[0]-o,r[1]-c,i[0]-o,i[1]-c,n[0]-o,n[1]-c,l[0]-o,l[1]-c,l[0]-o,l[1]-c,r[0]+t-o,r[1]-c,r[0]+t-o,r[1]-c,i[0]+t-o,i[1]-c,n[0]+t-o,n[1]-c,l[0]+t-o,l[1]-c]):a.set([r[0]-o,r[1]-c,i[0]-o,i[1]-c,n[0]-o,n[1]-c,l[0]-o,l[1]-c]),this.isWrapAround=h}getVAO(e,t,s){if(null==this.elementView.coords)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=F.createVertex(e,B.DYNAMIC_DRAW,i);const r=F.createVertex(e,B.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Y(e,s,t,{geometry:this._geometryVbo,tex:r})}return this._vao}_updatePerspectiveTransform(e,s){const i=this._vertices;O(t,[0,0,e,0,0,s,e,s],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),h(this.perspectiveTransform,t[6]/t[8]*e,t[7]/t[8]*s)}}class te extends z{constructor(){super(...arguments),this._localOrigin=u(0,0),this._viewStateId=-1,this._dvsMat3=d()}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const t of this.children)t.beforeRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"overlay",brushes:[I.overlay],target:()=>this.children,drawPhase:L.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){const{state:t}=e,{id:s,size:i,pixelRatio:r,resolution:n,rotation:l,viewpoint:a,displayMat3:o}=t;if(this._viewStateId===s)return;const c=Math.PI/180*l,h=r*i[0],u=r*i[1],{x:d,y:w}=a.targetGeometry,j=m(d,t.spatialReference);this._localOrigin.x=j,this._localOrigin.y=w;const R=n*h,x=n*u,T=y(this._dvsMat3);p(T,T,o),g(T,T,f(h/2,u/2)),_(T,T,N(h/R,-u/x,1)),v(T,T,-c),this._viewStateId=s}_updateOverlays(e,t){const{state:s}=e,{rotation:i,spatialReference:r,worldScreenWidth:n,size:l,viewpoint:a}=s,o=this._localOrigin;let c=0;const h=w(r);if(h&&r.isWrappable){const e=l[0],u=l[1],d=180/Math.PI*i,m=Math.abs(Math.cos(d)),y=Math.abs(Math.sin(d)),p=Math.round(e*m+u*y),[g,f]=h.valid,_=j(r),{x:v,y:w}=a.targetGeometry,R=[v,w],x=[0,0];s.toScreen(x,R);const T=[0,0];let M;M=p>n?.5*n:.5*p;const V=Math.floor((v+.5*_)/_),S=g+V*_,b=f+V*_,E=[x[0]+M,0];s.toMap(T,E),T[0]>b&&(c=_),E[0]=x[0]-M,s.toMap(T,E),T[0]<S&&(c=-_);for(const s of t){const e=s.elementView.bounds;if(null==e)continue;const[t,,i]=e;t<g&&i>g?s.updateDrawCoords(o,_):i>f&&t<f?s.updateDrawCoords(o,-_):s.updateDrawCoords(o,c)}}else for(const u of t)u.updateDrawCoords(o,c)}}let se=class extends(X(Z)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new R}attach(){this.addAttachHandles([x((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((e=>this._updateTile(e))),this.requestUpdate()})),x((()=>this.layer.effectiveSource),"change",(({element:e})=>this._elementUpdateHandler(e)))]),this._overlayContainer=new te,this.container.addChild(this._overlayContainer),this._fetchQueue=new T({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new M({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){const s=[],i=e.normalize(),r=[i.x,i.y];for(const{projectedElement:{normalizedCoords:n,element:l}}of this._elementReferences.values())null!=n&&V(n.rings,r)&&s.push({type:"media",element:l,layer:this.layer,mapPoint:e,sourcePoint:l.toSource(e)});return s.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((e=>this._updateTile(e)))}_acquireTile(e){const t=new le(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[s,i]=e.setElements(t);this._referenceElements(e,s),this._dereferenceElements(e,i),this.requestUpdate()}),(e=>{S(e)||o.getLogger(this).error(e)})))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const s=this.layer.effectiveSource;if(null==s)return[];this.view.featuresTilingScheme.getTileBounds(ie,e,!0);const i=new b({xmin:ie[0],ymin:ie[1],xmax:ie[2],ymax:ie[3],spatialReference:this.view.spatialReference});return s.queryElements(i,t)}_referenceElements(e,t){if(null!=this.layer.source)for(const s of t)this._referenceElement(e,s)}_referenceElement(e,t){E(this._elementReferences,t.uid,(()=>{const e=new P({element:t,spatialReference:this.view.spatialReference}),s=new ee(e);return this._overlayContainer.addChild(s),this.elements.add(t),{tiles:new Set,projectedElement:e,overlay:s,debugGraphic:null}})).tiles.add(e)}_dereferenceElements(e,t){for(const s of t)this._dereferenceElement(e,s)}_dereferenceElement(e,t){const s=this._elementReferences.get(t.uid);s.tiles.delete(e),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(s.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){const s=t.projectedElement.normalizedCoords;if(null==s)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const i=[],r=[];for(const e of this._tileStrategy.tiles){const n=ne(this.view.featuresTilingScheme,e,s);t.tiles.has(e)?n||r.push(e):n&&i.push(e)}for(const t of i)this._referenceElement(t,e);for(const t of r)this._dereferenceElement(t,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const s=new P({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=s)for(const i of this._tileStrategy.tiles)ne(this.view.featuresTilingScheme,i,s)&&this._referenceElement(i,e)}};C([A()],se.prototype,"layer",void 0),C([A({readOnly:!0})],se.prototype,"elements",void 0),se=C([G("esri.views.2d.layers.MediaLayerView2D")],se);const ie=q(),re={xmin:0,ymin:0,xmax:0,ymax:0};function ne(e,t,s){return e.getTileBounds(ie,t.key,!0),re.xmin=ie[0],re.ymin=ie[1],re.xmax=ie[2],re.ymax=ie[3],D(re,s)}class le{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const i of e)s.has(i)?s.delete(i):t.push(i);return this.isReady=!0,[t,Array.from(s)]}destroy(){}}e("default",se)}}}));
