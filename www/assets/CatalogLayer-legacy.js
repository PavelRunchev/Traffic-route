System.register(["./index-legacy.js","./lazyLayerLoader-legacy.js","./utils-legacy5.js","./FeatureLayerSource-legacy.js","./clientSideDefaults-legacy.js","./ClassBreaksDefinition-legacy.js","./meshVertexSpaceUtils-legacy.js","./MeshLocalVertexSpace-legacy.js","./vec3-legacy.js","./External-legacy.js","./infoFor3D-legacy.js","./editingSupport-legacy.js","./QueryTask-legacy.js","./executeForIds-legacy.js","./query-legacy.js","./pbfQueryUtils-legacy.js","./pbf-legacy.js","./OptimizedGeometry-legacy.js","./OptimizedFeatureSet-legacy.js","./executeQueryJSON-legacy.js","./executeQueryPBF-legacy.js","./featureConversionUtils-legacy.js","./QueryEngineCapabilities-legacy.js"],(function(e,t){"use strict";var r,i,o,s,a,l,n,y,u,p,d,c,h,f,g,m,v,b,j,I,w,L,F,_,x,S,T,P,O,R,C,V,E,Q,q,B,D,G,U,J,N,z,k,A,M,K,X,H;return{setters:[e=>{r=e.ef,i=e.bt,o=e.bs,s=e.dg,a=e.V,l=e.hd,n=e.e7,y=e.n,u=e.w,p=e.an,d=e.bw,c=e.am,h=e.x,f=e.y,g=e.fe,m=e.z,v=e.f8,b=e.fa,j=e.fc,I=e.fd,w=e.fb,L=e.di,F=e.ff,_=e.F,x=e.fg,S=e.fP,T=e.f6,P=e.dD,O=e.dd,R=e.dE,C=e.de,V=e.df,E=e.dG,Q=e.dF,q=e.db,B=e.bx,D=e.s,G=e.ey,U=e.ao,J=e.bG,N=e.az,z=e.dL,k=e.X,A=e.fk},e=>{M=e.a},e=>{K=e.T},e=>{X=e.default},e=>{H=e.o},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){class t{constructor(e,t){this.objectId=e,this.itemSource=t,this.count=0,this.layer=null,this.sortValue=void 0}}const W=new r(20,(e=>e.destroy()));let Y=class extends(i(o(s(d)))){constructor(e){super(e),this._oidToReference=new Map,this._layerToReference=new Map,this._portals=new Map,this.layers=new a,this.maximumVisibleSublayers=10,this.opacity=1,this.title="Layers In View",this.type="catalog-dynamic-group",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get _orderBy(){return this.parent.orderBy?.find((e=>!e.valueExpression&&e.field))??new l({field:this.parent.objectIdField})}get _referenceComparator(){const e=this._orderBy,t=this.parent.fieldsIndex.get(e.field),r=K(t?.toJSON().type,"descending"===e.order);return(e,t)=>r(e.sortValue,t.sortValue)||e.objectId-e.objectId}acquireLayer(e){const t=e.getObjectId(),r=n(this._oidToReference,t,(()=>this._createLayerReference(e)));return r.count++,y((()=>{r.count--,r.count||this._disposeLayerReference(r)}))}_createLayerReference(e){const r=e.getObjectId(),i=e.getAttribute(this.parent.itemSourceField),o=new t(r,i);if(W.get(i))return this._addLayer(W.pop(i),o,e),o;let s;try{s=JSON.parse(i)}catch(M){return u.getLogger(this).error(M),o}return this._createLayer(s).then((t=>{this.destroyed||0===o.count?(W.get(i)||W.put(o.itemSource,t),o.layer=null):this._addLayer(t,o,e)})).catch((()=>{})),o}_addLayer(e,t,r){this._layerToReference.set(e,t),t.sortValue=r.getAttribute(this._orderBy.field),t.layer=e,e.parent=this,this.layers.add(e),this.layers.sort(((e,t)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(t))))}_disposeLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),W.put(e.itemSource,e.layer)),this._oidToReference.delete(e.objectId)}async _createLayer(e){if(!function(e){return"object"==typeof e&&null!=e&&"itemId"in e&&"portalUrl"in e}(e))return new(await M.UnsupportedLayer());const{itemId:t,portalUrl:r}=e,i=n(this._portals,r,(()=>new p({url:r})));return d.fromPortalItem(new c({id:t,portal:i}))}};h([f()],Y.prototype,"_orderBy",null),h([f()],Y.prototype,"_referenceComparator",null),h([f({readOnly:!0})],Y.prototype,"layers",void 0),h([f()],Y.prototype,"maximumVisibleSublayers",void 0),h([f(g)],Y.prototype,"opacity",void 0),h([f({type:String,json:{name:"title",write:!0}})],Y.prototype,"title",void 0),h([f({json:{read:!1}})],Y.prototype,"type",void 0),h([f({type:Boolean,json:{name:"visibility",write:!0}})],Y.prototype,"visible",void 0),Y=h([m("esri.layers.catalog.CatalogDynamicGroupLayer")],Y);const Z=Y;let $=class extends(i(v(o(s(d))))){constructor(e){super(e),this.labelingInfo=null,this.labelsVisible=!0,this.legendEnabled=!0,this.opacity=1,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.type="catalog-footprint",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){return this.parent.fields}get fieldsIndex(){return this.parent.fieldsIndex}get geometryType(){return this.parent.geometryType}get objectIdField(){return this.parent.objectIdField}get orderBy(){return this.parent.orderBy}createPopupTemplate(e){const t={fields:this.parent.fields,objectIdField:this.parent.objectIdField,title:this.title};return b(t,e)}createQuery(){return this.parent.createQuery()}queryFeatures(e,t){return this.parent.queryFeatures(e,t)}};h([f({readOnly:!0})],$.prototype,"defaultPopupTemplate",null),h([f({type:[j],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:I,write:!0}})],$.prototype,"labelingInfo",void 0),h([f(w)],$.prototype,"labelsVisible",void 0),h([f(L)],$.prototype,"legendEnabled",void 0),h([f(g)],$.prototype,"opacity",void 0),h([f(F)],$.prototype,"popupEnabled",void 0),h([f({type:_,json:{name:"popupInfo",write:!0}})],$.prototype,"popupTemplate",void 0),h([f({types:x,json:{name:"layerDefinition.drawingInfo.renderer"}})],$.prototype,"renderer",void 0),h([f({json:{read:!1}})],$.prototype,"type",void 0),h([f({type:Boolean,json:{name:"visibility",write:!0}})],$.prototype,"visible",void 0),$=h([m("esri.layers.catalog.CatalogFootprintLayer")],$);const ee=$,te=A();let re=class extends(S(o(T(P(i(O(R(C(V(s(E(Q(q(d)))))))))))))){constructor(e){super(e),this.dynamicGroupLayer=new Z({parent:this}),this.fields=null,this.fieldsIndex=null,this.footprintLayer=new ee({parent:this}),this.itemSourceField="cd_itemsource",this.itemTypeField="cd_itemtype",this.layers=new a([this.dynamicGroupLayer,this.footprintLayer]),this.source=new X({layer:this}),this.type="catalog"}load(e){const t=null!=e?e.signal:null,r=this.loadFromPortal({supportedTypes:["Feature Service"]},e).catch(B).then((async()=>{if(!this.url)throw new D("catalog-layer:missing-url","Catalog layer must be created with a url");if(this.url&&null==this.layerId){const e=await this._fetchFirstValidLayerId(t);if(null==e)throw new D("catalog-layer:missing-layerId","There is no Catalog Layer in the service",{service:this.url});this.layerId=e}await this.source.load(),this.source.sourceJSON&&(this.sourceJSON=this.source.sourceJSON,this.read(this.source.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}))})).then((()=>G(this,"load",e)));return this.addResolvingPromise(r),Promise.resolve(this)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("capabilities"),(this._get("createQueryVersion")??0)+1}get parsedUrl(){const e=U(this.url);return null!=e&&null!=this.layerId&&(e.path=J(e.path,this.layerId.toString())),e}createQuery(){const e=new N,t=this.capabilities?.query;e.returnGeometry=!0,t&&(e.compactGeometryEnabled=t.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=t.supportsDefaultSpatialReference),e.outFields=["*"];const{timeOffset:r,timeExtent:i}=this;return e.timeExtent=null!=r&&null!=i?i.offset(-r.value,r.unit):i||null,e}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return this.fieldsIndex.get(e)?.domain}async queryFeatures(e,t){const r=await this.load(),i=await r.source.queryFeatures(N.from(e)??r.createQuery(),t);if(i?.features)for(const o of i.features)o.layer=o.sourceLayer=r.footprintLayer;return i}async queryObjectIds(e,t){return(await this.load()).source.queryObjectIds(N.from(e)??this.createQuery(),t)}async queryFeatureCount(e,t){return(await this.load()).source.queryFeatureCount(N.from(e)??this.createQuery(),t)}async queryExtent(e,t){return(await this.load()).source.queryExtent(N.from(e)??this.createQuery(),t)}serviceSupportsSpatialReference(e){return this.loaded&&z(this,e)}read(e,t){super.read(e,t);let r=e.footprintLayer;r||"service"!==t?.origin||(r={layerDefinition:{drawingInfo:H(e.geometryType)}}),this.footprintLayer.read(r,t)}_fetchFirstValidLayerId(e){return k(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then((e=>{const t=e.data;if(t)return Array.isArray(t.layers)?t.layers.find((e=>"Catalog Layer"===e.type))?.id:void 0}))}};h([f({readOnly:!0})],re.prototype,"createQueryVersion",null),h([f({...te.fields,json:{origins:{service:{name:"fields"}}}})],re.prototype,"fields",void 0),h([f(te.fieldsIndex)],re.prototype,"fieldsIndex",void 0),h([f({json:{read:!1,write:!1}})],re.prototype,"footprintLayer",void 0),h([f()],re.prototype,"itemSourceField",void 0),h([f()],re.prototype,"itemTypeField",void 0),h([f()],re.prototype,"layers",void 0),h([f({value:"CatalogLayer",type:["CatalogLayer"]})],re.prototype,"operationalLayerType",void 0),h([f()],re.prototype,"outFields",void 0),h([f({readOnly:!0})],re.prototype,"parsedUrl",null),h([f()],re.prototype,"source",void 0),h([f({json:{read:!1}})],re.prototype,"type",void 0),re=h([m("esri.layers.CatalogLayer")],re),e("default",re)}}}));
