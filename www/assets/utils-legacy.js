System.register(["./index-legacy.js","./originUtils-legacy.js","./jsonContext-legacy.js","./saveAPIKeyUtils-legacy.js","./saveUtils-legacy.js"],(function(e,t){"use strict";var a,r,o,i,n,s,l,c,p;return{setters:[e=>{a=e.am,r=e.an,o=e.i,i=e.s,n=e.f},e=>{s=e.i},e=>{l=e.o},e=>{c=e.i},e=>{p=e.t}],execute:function(){function t(e,t,a){const r=a(e);if(!r.isValid)throw new i(`${t}:invalid-parameters`,r.errorMessage,{layer:e})}async function u(e){const{layer:a,errorNamePrefix:r,validateLayer:o}=e;await a.load(),t(a,r,o)}function y(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function d(e){const{item:t,errorNamePrefix:a,layer:r,validateItem:o}=e;if(c(t),function(e){const{item:t,itemType:a,additionalItemType:r,errorNamePrefix:o,layer:n}=e,s=[a];if(r&&s.push(r),!s.includes(t.type)){const e=s.map((e=>`'${e}'`)).join(", ");throw new i(`${o}:portal-item-wrong-type`,`Portal item type should be one of: "${e}"`,{item:t,layer:n})}}(e),o){const e=o(t);if(!e.isValid)throw new i(`${a}:invalid-parameters`,e.errorMessage,{layer:r})}}function m(e){const{layer:t,errorNamePrefix:a}=e,{portalItem:r}=t;if(!r)throw new i(`${a}:portal-item-not-set`,y(t,"requires the portalItem property to be set"));if(!r.loaded)throw new i(`${a}:portal-item-not-loaded`,y(t,"cannot be saved to a portal item that does not exist or is inaccessible"));d({...e,item:r})}function f(e){const{newItem:t,itemType:o}=e;let i=a.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=o,i.portal??=r.getDefault(),d({...e,item:i}),i}function w(e){return l(e,"portal-item")}async function I(e,t,a){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),p(t,{errorName:"layer-write:unsupported"},a),r}function v(e){o(e,n.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}async function g(e,t,a){const r=e.portal;await r.signIn(),await(r.user?.addItem({item:e,data:t,folder:a?.folder}))}e({$:async function(e,t){const{layer:a,createItemData:r,createJSONContext:o,saveResources:i,supplementalUnsupportedErrors:n}=e;await u(e),m(e);const l=a.portalItem,c=o?o(l):w(l),p=await I(a,c,{...t,supplementalUnsupportedErrors:n}),y=await r({layer:a,layerJSON:p},l);return v(l),await l.update({data:y}),s(c),await(i?.(l,c)),l},I:I,P:g,c:y,d:m,j:async function(e,t){const{layer:a,createItemData:r,createJSONContext:o,setItemProperties:i,saveResources:n,supplementalUnsupportedErrors:l}=e;await u(e);const c=f(e),p=o?o(c):w(c),y=await I(a,p,{...t,supplementalUnsupportedErrors:l}),d=await r({layer:a,layerJSON:y},c);return await i(a,c),v(c),await g(c,d,t),a.portalItem=c,s(p),await(n?.(c,p)),c},l:t,v:v,w:w,y:f})}}}));
