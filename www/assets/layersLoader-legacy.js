System.register(["./index-legacy.js","./fetchService-legacy.js","./portalLayers-legacy.js","./layersCreator-legacy.js","./lazyLayerLoader-legacy.js","./jsonContext-legacy.js","./associatedFeatureServiceUtils-legacy.js"],(function(e,t){"use strict";var a,r,n,s,l,o,i,c,u,y,p,d,f,m,h,w,g,b,I,L;return{setters:[e=>{a=e.s,r=e.bB,n=e.bC,s=e.an,l=e.p},e=>{o=e.t},e=>{i=e.l,c=e.a,u=e.n,y=e.u,p=e.i,d=e.c,f=e.s,m=e.t,h=e.r,w=e.e},e=>{g=e.populateGroupLayer},e=>{b=e.t,I=e.a},e=>{L=e.e},null],execute:function(){async function t(e,t){const a=e.instance,n=a.portalItem;if(!n)return;const{url:s,title:l}=n,o=L(n,"portal-item");if("group"===a.type)return v(a,o,e);s&&"media"!==a.type&&a.read({url:s},o);const i=new w,c=await M(e,i,t);return c&&a.read(c,o),a.resourceReferences={portalItem:n,paths:o.readResourcePaths??[]},"subtype-group"!==a.type&&a.read({title:l},o),r(a,o)}async function v(e,t,r){const s=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:l,type:o}=s;if("Group Layer"===o){if(!n(s,"Map"))throw new a("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return async function(e){const t=e.portalItem,a=await t.fetchData("json");if(!a)return;const r=L(t,"web-map");e.read(a,r),await g(e,a,{context:r}),e.resourceReferences={portalItem:t,paths:r.readResourcePaths??[]}}(e)}return e.read({title:l},t),S(e,r)}async function S(e,t){let r;const{portalItem:n}=e;if(!n)return;const s=n.type,l=t.layerModuleTypeMap;switch(s){case"Feature Service":case"Feature Collection":r=l.FeatureLayer;break;case"Stream Service":r=l.StreamLayer;break;case"Scene Service":r=l.SceneLayer;break;default:throw new a("portal:unsupported-item-type-as-group",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const h=new w;let[g,I]=await Promise.all([r(),M(t,h)]),L=()=>g;if("Feature Service"===s){const t=i(I)?.customParameters;I=n.url?await c(I,n.url,h):{};const a=u(I),r=y(I),s=p(I),d=[];if(a.length||r?.length){a.length&&d.push("SubtypeGroupLayer"),r?.length&&d.push("OrientedImageryLayer"),s?.length&&d.push("CatalogLayer");const e=[];for(const a of d){const t=l[a];e.push(t())}const t=await Promise.all(e),n=new Map;d.forEach(((e,a)=>{n.set(e,t[a])})),L=e=>e.layerType?n.get(e.layerType)??g:g}const f=await async function(e,t){const{layersJSON:a}=await o(e,t);if(!a)return null;const r=[...a.layers,...a.tables];return e=>r.find((t=>t.id===e.id))}(n.url,{customParameters:t,loadContext:h});return await T(e,L,I,f)}return"Scene Service"===s&&n.url&&(I=await d(n,I,h)),f(I)>0?await T(e,L,I):await async function(e,t){const{portalItem:a}=e;if(!a?.url)return;const r=await b(a.url);r&&T(e,t,{layers:r.layers?.map(m),tables:r.tables?.map(m)})}(e,L)}async function T(e,t,a,r){let n=a.layers||[];const s=a.tables||[];if("Feature Collection"===e.portalItem?.type?(n.forEach(((e,t)=>{e.id=t,"Table"===e?.layerDefinition?.type&&s.push(e)})),n=n.filter((e=>"Table"!==e?.layerDefinition?.type))):(n.reverse(),s.reverse()),n.forEach((n=>{const s=r?.(n);if(s||!r){const r=j(e,t(n),a,n,s);e.add(r)}})),s.length){const t=await I.FeatureLayer();s.forEach((n=>{const s=r?.(n);if(s||!r){const r=j(e,t,a,n,s);e.tables.add(r)}}))}}function j(e,t,a,r,n){const l=e.portalItem,o={portalItem:l.clone(),layerId:r.id};null!=r.url&&(o.url=r.url);const i=new t(o);if("sourceJSON"in i&&(i.sourceJSON=n),"subtype-group"!==i.type&&"catalog"!==i.type&&(i.sublayerTitleMode="service-name"),"Feature Collection"===l.type){const e={origin:"portal-item",portal:l.portal||s.getDefault()};i.read(r,e);const t=a.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function M(e,t,r){if(!1===e.supportsData)return;const n=e.instance,s=n.portalItem;if(!s)return;let o=null;try{o=await s.fetchData("json",r)}catch(a){}if(function(e){return"stream"!==e.type&&"layerId"in e}(n)){let e=null;const a=await async function(e,t,a){if(t?.layers&&t?.tables)return f(t);const r=l(e.url);if(!r)return 1;const n=await a.fetchServiceMetadata(r.url.path,{customParameters:i(t)?.customParameters}).catch((()=>null));return(t?.layers?.length??n?.layers?.length??0)+(t?.tables?.length??n?.tables?.length??0)}(s,o,t);if((o?.layers||o?.tables)&&a>0){if(null==n.layerId){const e=u(o);n.layerId="subtype-group"===n.type?e?.[0]:h(o)}e=function(e,t){const{layerId:a}=t,r=e.layers?.find((e=>e.id===a))||e.tables?.find((e=>e.id===a));return r&&function(e,t){return!("feature"===t.type&&"layerType"in e&&"SubtypeGroupLayer"===e.layerType||"subtype-group"===t.type&&!("layerType"in e))}(r,t)?r:null}(o,n),e&&null!=o.showLegend&&(e.showLegend=o.showLegend)}return a>1&&"sublayerTitleMode"in n&&"service-name"!==n.sublayerTitleMode&&(n.sublayerTitleMode="item-title-and-service-name"),e}return o}e("load",(async function(e,r){const n=e.instance.portalItem;if(n?.id)return await n.load(r),function(e){const t=e.instance.portalItem;if(!t?.type||!e.supportedTypes.includes(t.type))throw new a("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t?.type,expectedType:e.supportedTypes.join(", ")})}(e),e.validateItem&&e.validateItem(n),t(e,r)}))}}}));
