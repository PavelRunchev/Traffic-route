System.register(["./index-legacy.js","./featureConversionUtils-legacy.js","./OptimizedFeatureSet-legacy.js","./geojson-legacy.js","./clientSideDefaults-legacy.js","./sourceUtils-legacy.js"],(function(e,n){"use strict";var t,i,a,r,s,o,l,c,u,d,f,m,g,p,y,w,b,h,j,F,I;return{setters:[e=>{t=e.s,i=e.cN,a=e.bf,r=e.X,s=e.cy,o=e.cx,l=e.aZ,c=e.bc,u=e.cO,d=e.cw,f=e.ao,m=e.w},e=>{g=e.l,p=e.r,y=e.o},e=>{w=e.e},e=>{b=e.E,h=e.I,j=e.N},e=>{F=e.o},e=>{I=e.p}],execute:function(){e({$:v,C:function(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=n?.groups;if(!t)return null;const{authority:i,code:a}=t;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return c.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return c.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}},N:async function(e,n={}){const{links:a,url:s}=e,o=C(a,"data",S.json)||C(a,"http://www.opengis.net/def/rel/ogc/1.0/data",S.json);if(null==o)throw new t("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=n,d=i(o.href,s),{data:f}=await r(d,{signal:u,headers:{accept:S.json},query:{...c,token:l}});for(const t of f.collections)t.landingPage=e;return f},O:async function(e,n={}){const{links:a,url:s}=e,o=C(a,"conformance",S.json)||C(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance",S.json);if(null==o)throw new t("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=n,d=i(o.href,s),{data:f}=await r(d,{signal:u,headers:{accept:S.json},query:{...c,token:l}});return f},P:async function(e,n={}){const{apiKey:t,customParameters:i,signal:a}=n,{data:s}=await r(e,{signal:a,headers:{accept:S.json},query:{...i,token:t}});return s.url=e,s},R:async function(e,n,t){const i=await v(e,n,t);return g(i)},q:async function(e,t={}){const{links:a,url:s}=e,o=C(a,"service-desc",S.openapi);if(null==o)return n().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:l,customParameters:c,signal:u}=t,d=i(o.href,s),{data:f}=await r(d,{signal:u,headers:{accept:S.openapi},query:{...c,token:l}});return f},v:async function(e,c,u={},d=5){const{links:f}=e,m=C(f,"items",S.geojson)||C(f,"http://www.opengis.net/def/rel/ogc/1.0/items",S.geojson);if(null==m)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:g,customParameters:p,signal:y}=u,w=i(m.href,e.landingPage.url),j={limit:d,...p,token:g},I=a(w,j),k={accept:S.geojson},{data:x}=await r(I,{signal:y,headers:k}),v=$(I,d,x.links)??T;b(x);const N=h(x,{geometryType:c.geometryType}),O=c.fields||N.fields||[],P=null!=c.hasZ?c.hasZ:N.hasZ,G=N.geometryType,R=c.objectIdField||N.objectIdFieldName||"OBJECTID";let W=c.timeInfo;const D=O.find((({name:e})=>e===R));if(D)D.editable=!1,D.nullable=!1;else{if(!N.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");O.unshift({name:R,alias:R,type:"number"===N.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(R!==N.objectIdFieldName){const e=O.find((({name:e})=>e===N.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}O===N.fields&&N.unknownFields.length>0&&n().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:N.unknownFields}});for(const n of O){if(null==n.name&&(n.name=n.alias),null==n.alias&&(n.alias=n.name),"esriFieldTypeOID"!==n.type&&"esriFieldTypeGlobalID"!==n.type&&(n.editable=null==n.editable||!!n.editable,n.nullable=null==n.nullable||!!n.nullable),!n.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:n});if(!s.jsonValues.includes(n.type))throw new t("ogc-feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}if(W){const e=new o(O);if(W.startTimeField){const n=e.get(W.startTimeField);n?(W.startTimeField=n.name,n.type="esriFieldTypeDate"):W.startTimeField=null}if(W.endTimeField){const n=e.get(W.endTimeField);n?(W.endTimeField=n.name,n.type="esriFieldTypeDate"):W.endTimeField=null}if(W.trackIdField){const t=e.get(W.trackIdField);t?W.trackIdField=t.name:(W.trackIdField=null,n().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:W}}))}W.timeReference||={timeZoneIANA:l},W.startTimeField||W.endTimeField||(n().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:W}}),W=null)}return{drawingInfo:G?F(G):null,extent:q(e),geometryType:G,fields:O,hasZ:!!P,objectIdField:R,paginationParameter:v,timeInfo:W}}});const n=()=>m.getLogger("esri.layers.ogc.ogcFeatureUtils"),T="startindex",k=new Set([T,"offset"]),x="http://www.opengis.net/def/crs/";var S;async function v(e,n,a){const{collection:{links:s,landingPage:{url:l}},layerDefinition:f,maxRecordCount:m,queryParameters:{apiKey:g,customParameters:b},spatialReference:h,supportedCrs:F}=e,T=C(s,"items",S.geojson)||C(s,"http://www.opengis.net/def/rel/ogc/1.0/items",S.geojson);if(null==T)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:x,start:v,timeExtent:O,where:q}=n;if(n.objectIds)throw new t("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const $=c.fromJSON(h),G=n.outSpatialReference??$,R=G.isWGS84?null:N(G,F),W=P(k,F),D=function(e){if(null==e)return null;const{start:n,end:t}=e;return`${null!=n?n.toISOString():".."}/${null!=t?t.toISOString():".."}`}(O),Z=function(e){return null!=e&&e&&"1=1"!==e?e:null}(q),M=x??(null==v?m:10),K=0===v?void 0:v,{fields:A,geometryType:L,hasZ:J,objectIdField:z,paginationParameter:E}=f,U=i(T.href,l),{data:_}=await r(U,{...a,query:{...b,...W,crs:R,datetime:D,query:Z,limit:M,[E]:K,token:g},headers:{accept:S.geojson}}),B=j(_,{geometryType:L,hasZ:J,objectIdField:z}),Q=B.length===M&&!!C(_.links??[],"next",S.geojson),V=new o(A);for(const t of B){const e={};I(V,e,t.attributes),e[z]=t.attributes[z],t.attributes=e}if(!R&&G.isWebMercator)for(const t of B)if(null!=t.geometry&&null!=L){const e=p(t.geometry,L,J,!1);e.spatialReference=c.WGS84,t.geometry=y(u(e,G))}for(const t of B)t.objectId=t.attributes[z];const X=R||!R&&G.isWebMercator?G.toJSON():d,H=new w;return H.exceededTransferLimit=Q,H.features=B,H.fields=A,H.geometryType=L,H.hasZ=J,H.objectIdFieldName=z,H.spatialReference=X,H}function N(e,n){const{isWebMercator:t,wkid:i}=e;if(!i)return null;const a=t?n[3857]??n[102100]??n[102113]??n[900913]:n[e.wkid];return a?`${x}${a}`:null}function O(e){if(null==e)return"";const{xmin:n,ymin:t,xmax:i,ymax:a}=e;return`${n},${t},${i},${a}`}function P(e,n){if(!function(e){return null!=e&&"extent"===e.type}(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:O(e)};const i=N(t,n);return null!=i?{bbox:O(e),"bbox-crs":i}:t.isWebMercator?{bbox:O(u(e,c.WGS84))}:null}function q(e){const n=e.extent?.spatial;if(!n)return null;const t=n.bbox[0],i=4===t.length,[a,r]=t,s=i?void 0:t[2];return{xmin:a,ymin:r,xmax:i?t[2]:t[3],ymax:i?t[3]:t[4],zmin:s,zmax:i?void 0:t[5],spatialReference:c.WGS84.toJSON()}}function C(e,n,t){return e.find((({rel:e,type:i})=>e===n&&i===t))??e.find((({rel:e,type:t})=>e===n&&!t))}function $(e,n,t){if(!t)return;const i=C(t,"next",S.geojson),a=f(i?.href)?.query;if(!a)return;const r=f(e).query,s=Object.keys(r??{}),o=Object.entries(a).filter((([e])=>!s.includes(e))).find((([e,t])=>k.has(e.toLowerCase())&&Number.parseInt(t,10)===n)),l=o?.[0];return l}e({k:x,x:`${x}OGC/1.3/CRS84`}),function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"}(S||(S={}))}}}));
