System.register(["./UpdateTracking2D-legacy.js","./index-legacy.js","./definitions-legacy.js","./Container-legacy.js","./enums-legacy.js","./Program-legacy.js","./ProgramTemplate-legacy.js","./VertexElementDescriptor-legacy.js","./LabelMetric-legacy.js","./Texture-legacy.js","./constants-legacy.js","./WGLContainer-legacy.js"],(function(e,t){"use strict";var i,s,r,o,a,n,l,u,c,p,d,h,f,m,y,v,b,g,x,w,S,V,_,z,M,T,P,F,A,I,R,C,O,E,D,L,B,k,N,U,H,W,G,j,q,$,K,X,Z,Y,Q,J,ee,te,ie,se,re,oe,ae,ne,le,ue,ce,pe,de,he,fe,me,ye,ve,be,ge,xe,we,Se,Ve,_e,ze,Me,Te,Pe,Fe,Ae,Ie,Re,Ce,Oe,Ee,De,Le,Be,ke,Ne,Ue,He,We,Ge,je,qe,$e,Ke,Xe,Ze,Ye,Qe,Je,et,tt,it,st,rt,ot,at,nt,lt,ut,ct,pt,dt,ht,ft,mt,yt,vt,bt,gt,xt,wt,St,Vt,_t,zt,Mt,Tt,Pt,Ft,At,It,Rt,Ct,Ot,Et,Dt,Lt,Bt,kt,Nt,Ut,Ht,Wt;return{setters:[e=>{i=e.g,s=e._,r=e.h,o=e.P,a=e.j,n=e.i,l=e.G,u=e.m,c=e.B,p=e.p,d=e.q,h=e.H,f=e.u,m=e.v,y=e.w,v=e.C,b=e.S,g=e.F,x=e.x,w=e.y,S=e.z,V=e.A,_=e.D,z=e.E,M=e.I,T=e.L,P=e.M,F=e.N,A=e.O,I=e.a,R=e.Q,C=e.R,O=e.T,E=e.V,D=e.X,L=e.Y,B=e.$,k=e.a0,N=e.a1,U=e.a2,H=e.a3,W=e.a4,G=e.a5,j=e.a6,q=e.a7,$=e.a8,K=e.a9,X=e.aa,Z=e.ab,Y=e.ac,Q=e.ad,J=e.ae,ee=e.af,te=e.ag,ie=e.ah,se=e.ai,re=e.aj,oe=e.ak,ae=e.al,ne=e.am,le=e.an,ue=e.ao,ce=e.ap,pe=e.aq,de=e.ar,he=e.as,fe=e.at,me=e.au,ye=e.av,ve=e.aw,be=e.ax,ge=e.ay,xe=e.az,we=e.aA,Se=e.aB,Ve=e.aC,_e=e.aD,ze=e.aE,Me=e.aF,Te=e.aG,Pe=e.aH,Fe=e.aI,Ae=e.aJ,Ie=e.aK,Re=e.aL,Ce=e.aM,Oe=e.aN,Ee=e.aO,De=e.aP,Le=e.aQ,Be=e.aR,ke=e.aS,Ne=e.aT,Ue=e.K,He=e.d},e=>{We=e.x,Ge=e.lu,je=e.iq,qe=e.s,$e=e.g6,Ke=e.w,Xe=e.jj,Ze=e.i2,Ye=e.jD,Qe=e.c3,Je=e.b5,et=e.lf,tt=e.lv,it=e.q,st=e.kq},e=>{rt=e.a,ot=e.K,at=e.L,nt=e.d,lt=e.u,ut=e.i},e=>{ct=e.E,pt=e.S,dt=e.f,ht=e.m,ft=e.c,mt=e.y,yt=e.M,vt=e.d,bt=e.e,gt=e.w,xt=e.L},e=>{wt=e.C,St=e.F,Vt=e.L,_t=e.D,zt=e.B,Mt=e.E,Tt=e.U,Pt=e._,Ft=e.G,At=e.P,It=e.O,Rt=e.I},e=>{Ct=e.h,Ot=e.s,Et=e.i,Dt=e.x},e=>{Lt=e.o},e=>{Bt=e.t},e=>{kt=e.a},e=>{Nt=e.e,Ut=e.m},e=>{Ht=e.o},e=>{Wt=e.c}],execute:function(){e({F:function(){for(const e in Li)Li[e].startup()},S:ps,T:function(e){for(const t in Li)Li[t].shutdown(e)},a:ms,c:function(e){const t={...ts};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const i of Wi(e.visualVariables))switch(i.type){case"color":t.visualVariableColor=Ki(i);break;case"opacity":t.visualVariableOpacity=Xi(i);break;case"rotation":t.visualVariableRotation=Zi(i);break;case"size":switch(ss(i)){case"field-stops":t.visualVariableSizeStops=Yi(i);break;case"scale-stops":"outline"===i.target?t.visualVariableSizeOutlineScaleStops=Yi(i):t.visualVariableSizeScaleStops=Yi(i);break;case"min-max":t.visualVariableSizeMinMaxValue=es(i);break;case"unit-value":t.visualVariableSizeUnitValue=Qi(i)}break;default:console.error("Unable to handle VV type")}return t},d:ki,e:is,f:as,g:xs,m:function(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!function(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=Ye();return e&&t||i}()){const e=Ye(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((t=>!e[t])).join(", ");return Hi().errorOnce(new qe("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0},n:async function(e,t){const{cimResourceManager:i,cimAnalyzer:s,scaleExpression:r}=t.schemaOptions;await Promise.all(Ue.fetchResources(e.symbol,i,[]));const o=s.analyzeSymbolReference(e,!1),a={scaleInfo:rs(e),scaleExpression:r},n=[];for(const l of o)switch(l.type){case"marker":n.push(...ns(l,t,a));break;case"fill":n.push(...cs(l,t,a));break;case"line":n.push(...ds(l,t,a));break;case"text":n.push(...ys(l,t,a))}return n},p:us,r:rs,t:function(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:Ye().maxTextureSize},bindings:gs(e)}},u:ls,y:vs,z:fs});let t=class{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=ct.MAP|ct.HITTEST|ct.HIGHLIGHT|ct.DEBUG,this.symbologyPlane=pt.FILL}startup(){}shutdown(e){}postProcess(e,t){}},Gt=class extends r{};We([i(0,v)],Gt.prototype,"pos",void 0);let jt=class extends o{};We([s(p)],jt.prototype,"dotSize",void 0);let qt=class extends o{};We([s(b)],qt.prototype,"locations",void 0),We([s(p)],qt.prototype,"pixelRatio",void 0),We([s(p)],qt.prototype,"tileZoomFactor",void 0);class $t extends a{vertex(e){const t=new n(1,0,0,0,-1,0,0,1,1).multiply(new l(e.pos.xy.divide(rt),1)),i=u(this.draw.locations,t.xy),s=c(this.instance.dotSize.divide(2),new p(1));let r=new p(0);r=r.add(d(i.a,new p(1e-6)).multiply(2));let o=s.add(this.instance.dotSize);const a=this.view.displayViewScreenMat3.multiply(new l(e.pos.add(.5),1)),f=new h(a.xy,r,1),m=this.instance.dotSize.divide(o),y=new p(-1).divide(s.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:f,glPointSize:o,color:i,ratio:m,invEdgeRatio:y}}fragment(e){const t=f(e.glPointCoord.subtract(.5)).multiply(2),i=m(new p(0),new p(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new g;return s.glFragColor=e.color.multiply(i),s}}We([s(jt)],$t.prototype,"instance",void 0),We([s(qt)],$t.prototype,"draw",void 0),We([s(x)],$t.prototype,"view",void 0),We([Ge(0,y(Gt))],$t.prototype,"vertex",null),We([Ge(0,y(class extends w{}))],$t.prototype,"fragment",null);class Kt extends _{}We([i(3,p)],Kt.prototype,"inverseArea",void 0);let Xt=class extends o{};We([s(S.ofType(h,2))],Xt.prototype,"isActive",void 0),We([s(S.ofType(h,8))],Xt.prototype,"colors",void 0),We([s(p)],Xt.prototype,"dotValue",void 0);let Zt=class extends o{};We([s(b)],Zt.prototype,"dotTexture0",void 0),We([s(b)],Zt.prototype,"dotTexture1",void 0),We([s(p)],Zt.prototype,"tileZoomFactor",void 0),We([s(p)],Zt.prototype,"pixelRatio",void 0),We([s(p)],Zt.prototype,"tileDotsOverArea",void 0);let Yt=class extends z{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new n(2/rt,0,0,0,-2/rt,0,-1,1,1).multiply(new l(e.pos,1)),i=this.clip(e.id),s=new h(t.xy,i,1),r=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),a=this.draw.tileZoomFactor.multiply(rt).divide(this.draw.pixelRatio),u=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),c=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),p=e.pos.add(.5).divide(a);return{glPosition:s,color:new h(0,0,0,0),textureCoords:p,thresholds0:u,thresholds1:c}}fragment(e){const t=new g,i=u(this.draw.dotTexture0,e.textureCoords),s=u(this.draw.dotTexture1,e.textureCoords),r=e.thresholds0.subtract(i),o=e.thresholds1.subtract(s);let a;const n=M.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),l=M.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=d(new p(0),r),t=d(new p(0),o),i=T(e,r).add(T(t,o)),s=d(i,new p(0)),u=new p(1).subtract(s),c=i.add(s),h=r.multiply(e).divide(c),f=o.multiply(t).divide(c),m=n.multiply(h).add(l.multiply(f));a=u.multiply(m)}else{const e=c(P(r),P(o)),t=d(e,new p(0)),i=new p(1).subtract(t),s=d(e,r),u=d(e,o),h=n.multiply(s).add(l.multiply(u));a=i.multiply(h)}return t.glFragColor=a,t}hittest(e){return F(this.hittestRequest)}};We([V],Yt.prototype,"blending",void 0),We([s(Xt)],Yt.prototype,"instance",void 0),We([s(Zt)],Yt.prototype,"draw",void 0),We([Ge(0,y(Kt))],Yt.prototype,"vertex",null),We([Ge(0,y(w))],Yt.prototype,"fragment",null);const Qt={[wt.BYTE]:1,[wt.UNSIGNED_BYTE]:1,[wt.SHORT]:2,[wt.UNSIGNED_SHORT]:2,[wt.INT]:4,[wt.UNSIGNED_INT]:4,[wt.FLOAT]:4};let Jt=class{constructor(e,t){this._boundPart=null;const i=[];for(const r of t.vertex){const t=Ct.createVertex(e,St.STATIC_DRAW,r);i.push(t)}const s=[];for(const r of t.index||[]){const t=Ct.createIndex(e,St.STATIC_DRAW,r);s.push(t)}this.groups=[];for(const r of t.groups){let o;if(null!=r.index){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:e}=t.index[r.index];2===e?o=wt.UNSIGNED_SHORT:4===e&&(o=wt.UNSIGNED_INT)}const a=null!=r.index?s[r.index]:null,n=new Map,l={},u={};for(const e of r.attributes){const{name:t,count:s,type:r,offset:o,normalized:a,divisor:c,stride:p,vertex:d,location:h}=e,f=`vertex-buffer-${d}`;let m=l[f];m||(m=l[f]=[]);const y=new Bt(t,s,r,o,p,a,c);m.push(y),n.set(t,h),u[f]=i[d]}const c=new Lt(e,n,l,u,a);this.groups.push({...r,vertexArray:c,locations:n,layout:l,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:i}=this.parts[this._boundPart],{vertexArray:s}=this.groups[i];e.bindVAO(s)}draw(e){if(null==this._boundPart)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:s}=this.parts[this._boundPart],{indexing:r,primitive:o}=this.groups[s];r?e.drawElements(o,i,r,t*Qt[r]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}},ei=class e extends Jt{static create(t,i){const s=[];let{stride:r,hash:o}=i.layout;if(null==r){r=0;for(const{count:e,type:t,offset:s}of i.layout.attributes){if(null!=s)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=e*Qt[t]}}let a=0,n=0;for(const{count:e,name:d,offset:h,type:f,normalized:m}of i.layout.attributes){null!=h&&(n=h);const t={name:d,location:a,vertex:0,count:e,type:f,offset:n,stride:r,divisor:0,normalized:null!=m&&m};s.push(t),a++,n+=e*Qt[f]}const l={attributes:s,primitive:i.primitive};null!=i.index&&(l.index=0);let{count:u}=i;if(null==u&&(u=i.index?i.index.length:i.vertex.byteLength/r,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);const c={start:0,count:u,group:0,primitive:i.primitive},p={vertex:[i.vertex],parts:[c],groups:[l]};return null!=i.index&&(p.index=[i.index]),null==o&&(o=kt(s)),new e(t,p,{hash:o,attributes:s,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}},ti=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=rt,i=rt,s=new Nt(t,i);s.samplingMode=Vt.NEAREST,s.wrapMode=_t.CLAMP_TO_EDGE;const r=new Ot(e,new Et(zt.DEPTH_STENCIL,t,i));this._dotFBO=new Dt(e,s,r)}return this._dotFBO}getDotDensityMesh(e){if(null==this._dotMesh){const t=rt,i=t*t,s=2,r=new Int16Array(i*s);for(let e=0;e<t;e++)for(let i=0;i<t;i++)r[s*(i+e*t)]=i,r[s*(i+e*t)+1]=e;const o=[{count:2,type:wt.UNSIGNED_SHORT,name:"a_position",offset:0}],a={hash:kt(o),attributes:o,stride:4};this._dotMesh=ei.create(e,{primitive:Mt.POINTS,vertex:r,count:i,layout:a})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const s=new je(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let o=0;o<s.length;o++)s[o]=i.getFloat();const r=new Nt;return r.dataType=Tt.FLOAT,r.samplingMode=Vt.NEAREST,r.width=t,r.height=t,new Ut(e,r,s)}};function ii(e){const t=1/e;return{antialiasing:t,blur:0+t}}let si=class{constructor(e,t,i,s){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=s}},ri=class{destroy(){this._accumulateFramebuffer=$e(this._accumulateFramebuffer),this._resolveGradientTexture=$e(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=function(e,t){const{textureFloat:i,colorBufferFloat:s}=e.capabilities,r=i?.textureFloatLinear,o=s?.textureFloat,a=s?.textureHalfFloat,n=s?.floatBlend,l=e.driverTest.floatBufferBlend.result;if(!o&&!a)throw new qe("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(n&&l||a))throw new qe("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(l?"":" This device claims support for EXT_float_blend, but does not actually support it."));const u=o&&n&&l,c=a,p=r,d=!!s?.R32F,h=!!s?.R16F;if(u&&p)return p||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new si(Tt.FLOAT,p?Vt.LINEAR:Vt.NEAREST,d?Ft.RED:Ft.RGBA,d?At.R32F:Ft.RGBA);if(c)return new si(Tt.HALF_FLOAT,Vt.LINEAR,h?Ft.RED:Ft.RGBA,h?At.R16F:Ft.RGBA);throw new qe("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}(e,Ke.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"));this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Tt.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(null==this._accumulateFramebuffer){const{dataType:s,samplingMode:r,pixelFormat:o,internalFormat:a}=this.loadQualityProfile(e),n=new Nt(t,i);n.pixelFormat=o,n.internalFormat=a,n.dataType=s,n.samplingMode=r,n.wrapMode=_t.CLAMP_TO_EDGE;const l=new Et(zt.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Dt(e,n,l)}else{const{width:e,height:s}=this._accumulateFramebuffer;e===t&&s===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(null==this._resolveGradientTexture){const t=new Nt;t.wrapMode=_t.CLAMP_TO_EDGE,this._resolveGradientTexture=new Ut(e,t)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function oi(e){return e?.25:1}let ai=class extends _{};We([i(5,v)],ai.prototype,"offset",void 0);let ni=class extends o{};We([s(p)],ni.prototype,"radius",void 0),We([s(p)],ni.prototype,"isFieldActive",void 0);let li=class extends z{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,r=i.multiply(this.storage.getVVData(e.id).x).add(new p(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new l(e.pos,1)).add(this.view.displayViewMat3.multiply(new l(s,0)).multiply(t)),a=this.clip(e.id);return{glPosition:new h(o.xy,a,1),offset:s,fieldValue:r,color:new h(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=f(t),r=d(s,new p(1)),o=new p(1).subtract(s.multiply(s)),a=o.multiply(o),n=r.multiply(a).multiply(i).multiply(new p(oi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new h(n),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,s=t.multiply(i).multiply(new l(e.pos,1));return L(s.xy,this.kernelControls.radius,this.hittestRequest.position)}};We([V],li.prototype,"usesHalfFloatPrecision",void 0),We([s(ni)],li.prototype,"kernelControls",void 0),We([Ge(0,y(ai))],li.prototype,"vertex",null),We([Ge(0,y(class extends w{}))],li.prototype,"fragment",null);let ui=class extends r{};We([i(0,v)],ui.prototype,"pos",void 0);let ci=class extends o{};We([s(b)],ci.prototype,"texture",void 0),We([s(v)],ci.prototype,"minAndInvRange",void 0),We([s(p)],ci.prototype,"normalization",void 0);let pi=class extends o{};We([s(b)],pi.prototype,"texture",void 0);let di=class extends a{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new h(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=u(t.texture,e.uv).r.multiply(new p(oi(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const r=u(i.texture,new v(s,.5)),o=new g;return o.glFragColor=new h(r.rgb.multiply(r.a),r.a),o}};function hi(e){return e.key.level+1}We([V],di.prototype,"usesHalfFloatPrecision",void 0),We([s(ci)],di.prototype,"accumulatedDensity",void 0),We([s(pi)],di.prototype,"gradient",void 0),We([Ge(0,y(ui))],di.prototype,"vertex",null),We([Ge(0,y(class extends B{}))],di.prototype,"fragment",null);const fi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:hi,compare:It.GEQUAL,mask:255,op:{fail:Rt.KEEP,zFail:Rt.KEEP,zPass:Rt.REPLACE}}}},mi={...fi,stencil:!1},yi={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function vi(e,t){const{referenceScale:i,radius:s}=e;return s*(0!==i?i/t.scale:1)}let bi=class extends o{getVVRotationMat4(e){return k(N(e),M.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(W),i=G(t),s=j(t);return new M(s,i,0,0,i.multiply(new p(-1)),s,0,0,0,0,1,0,0,0,0,1)}))}getVVRotationMat3(e){return k(N(e),n.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(W),i=G(t),s=j(t);return new n(s,i,0,i.multiply(new p(-1)),s,0,0,0,1)}))}_getNormalizedAngle(e){const t=U(this.rotationType,new p(H.Arithmatic));return k(t,new p(90).subtract(e),e)}};We([s(p)],bi.prototype,"rotationType",void 0);const gi=360/254;class xi extends _{}We([i(3,h)],xi.prototype,"color",void 0),We([i(4,v)],xi.prototype,"offset",void 0),We([i(5,v)],xi.prototype,"textureUV",void 0),We([i(6,p)],xi.prototype,"fontSize",void 0),We([i(7,p)],xi.prototype,"referenceSize",void 0),We([i(8,p)],xi.prototype,"haloFontSize",void 0),We([i(9,h)],xi.prototype,"haloColor",void 0),We([i(10,v)],xi.prototype,"zoomRange",void 0),We([i(11,p)],xi.prototype,"clipAngle",void 0),We([i(12,h)],xi.prototype,"referenceSymbol",void 0);let wi=class extends ${};We([i(13,v)],wi.prototype,"offsetNextVertex1",void 0),We([i(14,v)],wi.prototype,"offsetNextVertex2",void 0);class Si extends z{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const s=t.multiply(gi),r=K(this.view.rotation.subtract(s)),o=X(new p(360).subtract(r),r);let a=new p(0);const n=Z(this.view.currentZoom.multiply(nt)).divide(nt),l=e.x,u=e.y,c=new p(1).subtract(d(l,n)).multiply(2),h=d(new p(90),o).multiply(2),f=new p(2).multiply(new p(1).subtract(d(n,u)));return a=a.add(i.multiply(c)),a=a.add(i.multiply(h)),a=a.add(f),a}vertex(e,t){const i=Y(e.bitset,ne),s=new p(1).subtract(i);let r=e.fontSize,o=r.divide(Q);const a=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?a.multiply(this.storage.getAnimationValue(e.id)):a,c=this.view.displayViewScreenMat3.multiply(new l(e.pos,1));let d=e.offset,f=new p(1),m=n.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,i=t.xy,s=t.z,r=this._unpackDirection(t.w),o=J(this,e.id,s).divide(2),a=r.multiply(o.add(lt));d=d.add(i).add(a)}else f=J(this,e.id,e.referenceSize).divide(e.referenceSize),r=r.multiply(f),o=o.multiply(f),d=d.multiply(f),m=ee(this,e.id),d=m.multiply(new l(d,0)).xy;const y=Y(e.bitset,le),v=this._getViewRotationMatrix(y).multiply(new l(d,0));let b=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,y):this.clip(e.id,e.zoomRange);b=this.isBackgroundPass?b.add(s.multiply(2)):b.add(i.multiply(2));const g=new h(c.xy.add(v.xy),b,1),x=e.textureUV.divide(this.mosaicInfo.size);let w=new p(0);return this.isHaloPass&&(w=e.haloFontSize.divide(o).divide(te)),{glPosition:g,color:u,size:o,textureUV:x,antialiasingWidth:new p(.105*Q).divide(r).divide(this.view.pixelRatio),haloDistanceOffset:w,...this.maybeRunHittest(e,t,{vvSizeAdjustment:f,vvRotation:m})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new p(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new p(2/8),i=new p(1).subtract(t),s=u(this.mosaicInfo.texture,e.textureUV).a;let r=i.subtract(e.haloDistanceOffset);this.highlight&&(r=r.divide(2));const o=e.antialiasingWidth,a=m(r.subtract(o),r.add(o),s);return this.getFragmentOutput(e.color.multiply(a),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s}){const r=s.multiply(new l(e.offset.multiply(i),0)),o=s.multiply(new l(t.offsetNextVertex1.multiply(i),0)),a=s.multiply(new l(t.offsetNextVertex2.multiply(i),0)),{viewMat3:n,tileMat3:u}=this.view,c=n.multiply(u).multiply(new l(e.pos,1)),p=c.add(u.multiply(r)).xy,d=c.add(u.multiply(o)).xy,h=c.add(u.multiply(a)).xy;return ie(this.hittestRequest.position,p.xy,d.xy,h.xy)}_unpackDirection(e){const t=new se(e),i=re(t,new se(2)),s=oe(t,new se(3));return new v(new p(i).subtract(1),new p(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new ae(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}}We([q(ue)],Si.prototype,"visualVariableColor",void 0),We([q(ce)],Si.prototype,"visualVariableOpacity",void 0),We([q(bi)],Si.prototype,"visualVariableRotation",void 0),We([q(pe)],Si.prototype,"visualVariableSizeMinMaxValue",void 0),We([q(de)],Si.prototype,"visualVariableSizeScaleStops",void 0),We([q(he)],Si.prototype,"visualVariableSizeStops",void 0),We([q(fe)],Si.prototype,"visualVariableSizeUnitValue",void 0),We([s(me)],Si.prototype,"mosaicInfo",void 0),We([V],Si.prototype,"isHaloPass",void 0),We([V],Si.prototype,"isBackgroundPass",void 0),We([V],Si.prototype,"isLabel",void 0),We([Ge(0,y(xi)),Ge(1,y(wi))],Si.prototype,"vertex",null),We([Ge(0,y(class extends w{}))],Si.prototype,"fragment",null);class Vi extends ve{}We([i(9,p)],Vi.prototype,"accumulatedDistance",void 0),We([i(10,v)],Vi.prototype,"segmentDirection",void 0),We([i(11,h)],Vi.prototype,"tlbr",void 0);class _i extends ye{_getLineWidthRatio(e,t){const i=new p(Ht),s=Y(e.bitset,ze);return s.multiply(c(t,new p(.25))).add(new p(1).subtract(s)).divide(i)}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:s,patternSize:r,accumulatedDistance:o,lineWidthRatio:a}=e,n=r.x.multiply(new p(2)).multiply(a),l=be(o.divide(n)),c=new p(.25).multiply(i.y).add(new p(.5)),d=ge(s.xy,s.zw,new v(l,c)),f=xe(u(this.mosaicInfo.texture,d)).subtract(new p(.5)).multiply(t),m=we(new p(.5).subtract(f),new p(0),new p(1));return new h(m)}_getPatternColor(e){const{halfWidth:t,normal:i,color:s,accumulatedDistance:r,patternSize:o,sampleAlphaOnly:a,tlbr:n}=e,l=o.y.multiply(new p(2).multiply(t).divide(o.x)),c=be(r.divide(l)),d=new p(.5).multiply(i.y).add(new p(.5)),f=ge(n.xy,n.zw,new v(d,c));let m=u(this.mosaicInfo.texture,f);return null!=this.visualVariableColor&&(m=k(Se(a,new p(.5)),new h(s.a),s)),m}vertex(e,t){const{segmentDirection:i,tlbr:s,bitset:r}=e,o=Ve(this,e),a=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(T(i,o.scaledOffset)),n=new v(s.z.subtract(s.x),s.w.subtract(s.y)),l=s.divide(this.mosaicInfo.size.xyxy),u=Y(r,Me),c=Y(r,Te),d=k(Se(u,new p(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new p(1));return{...o,tlbr:l,patternSize:n,accumulatedDistance:a,isSDF:u,sampleAlphaOnly:c,lineWidthRatio:d,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:s}=e,r=_e(e,this.antialiasingControls.blur),o=k(Se(s,new p(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),a=t.multiply(i).multiply(r).multiply(o);return this.getFragmentOutput(a,e)}}We([s(me)],_i.prototype,"mosaicInfo",void 0),We([Ge(0,y(Vi)),Ge(1,y(Pe))],_i.prototype,"vertex",null);class zi extends _{}We([i(3,h)],zi.prototype,"color",void 0),We([i(4,h)],zi.prototype,"outlineColor",void 0),We([i(5,v)],zi.prototype,"offset",void 0),We([i(6,v)],zi.prototype,"textureUV",void 0),We([i(7,h)],zi.prototype,"sizing",void 0),We([i(8,p)],zi.prototype,"placementAngle",void 0),We([i(9,p)],zi.prototype,"sizeRatio",void 0),We([i(10,v)],zi.prototype,"zoomRange",void 0);class Mi extends ${}function Ti(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function Pi(e){return e.multiply(e).divide(128)}We([i(12,v)],Mi.prototype,"offsetNextVertex1",void 0),We([i(13,v)],Mi.prototype,"offsetNextVertex2",void 0),We([i(14,v)],Mi.prototype,"textureUVNextVertex1",void 0),We([i(15,v)],Mi.prototype,"textureUVNextVertex2",void 0);class Fi extends z{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Pi(e.sizing.x),s=Pi(e.sizing.y),r=Pi(e.sizing.z),o=e.placementAngle,a=Y(e.bitset,ke.bitset.isSDF),u=Y(e.bitset,ke.bitset.isMapAligned),d=Y(e.bitset,ke.bitset.scaleSymbolsProportionally),f=Fe(e.bitset,ke.bitset.colorLocked),m=Ae(this,e.id),y=Ie(this,e.id,e.color,f).multiply(m),v=this.view.displayViewScreenMat3.multiply(new l(e.pos.xy,1)),b=J(this,e.id,r).divide(r),g=i.multiply(b),x=e.offset.xy.multiply(b);let w=s.multiply(d.multiply(b.subtract(1)).add(1));w=X(w,c(g.subtract(.99),new p(0)));const S=c(w,new p(1)),V=X(w,new p(1)),_=n.fromRotation(o.multiply(Re)),z=ee(this,e.id),M=this._getViewRotationMatrix(u).multiply(z).multiply(_).multiply(new l(x.xy,0)),T=this.clip(e.id,e.zoomRange),P=new h(v.xy.add(M.xy),T,1),F=e.textureUV.divide(this.mosaicInfo.size),A=e.outlineColor.multiply(V),I=Y(e.bitset,ke.bitset.overrideOutlineColor),R=e.sizeRatio.multiply(g).multiply(.5);return{glPosition:P,color:y,textureUV:F,outlineColor:A,outlineSize:S,distanceToPx:R,isSDF:a,overrideOutlineColor:I,...this.maybeRunHittest(e,t,{pos:e.pos,size:g,sizeCorrection:b,isMapAligned:u,outlineSize:S,distanceToPx:R,isSDF:a})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return k(Ce(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new p(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,s=new p(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getColor(e,t){return k(U(t.isSDF,new p(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return u(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=u(this.mosaicInfo.texture,e),s=new p(.5).subtract(xe(i)).multiply(t.distanceToPx).multiply(Oe),r=we(new p(.5).subtract(s),new p(0),new p(1)),o=t.color.multiply(r);let a=t.outlineSize;this.highlight&&(a=c(a,t.overrideOutlineColor.multiply(4)));const n=a.multiply(.5),l=K(s).subtract(n),d=we(new p(.5).subtract(l),new p(0),new p(1)),h=ge(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new p(1).subtract(h.a).multiply(o).add(h)}_hittestSmallMarker(e,t,i){const{position:s,distance:r,smallSymbolDistance:o}=this.hittestRequest,a=r.subtract(o),{viewMat3:n,tileMat3:u}=this.view,c=n.multiply(u).multiply(new l(i.pos,1)).xy,p=i.size.multiply(.5);return Ee(c,s).subtract(p).add(a)}_hittestMarker(e,t,i){const{pos:s,size:r,sizeCorrection:o,isMapAligned:a,outlineSize:n,isSDF:u,distanceToPx:c}=i,f=new l(e.offset.multiply(o),0),m=new l(t.offsetNextVertex1.multiply(o),0),y=new l(t.offsetNextVertex2.multiply(o),0),{viewMat3:b,tileMat3:g}=this.view,x=b.multiply(g).multiply(new l(s,1)),w=this._getViewScreenMatrix(a),S=x.add(w.multiply(f)).xy,V=x.add(w.multiply(m)).xy,_=x.add(w.multiply(y)).xy,z=this.hittestRequest.position,M=this.hittestRequest.distance,T=De(z.add(new v(Le(M),Le(M))),S,V,_),P=De(z.add(new v(0,Le(M))),S,V,_),A=De(z.add(new v(M,Le(M))),S,V,_),I=De(z.add(new v(Le(M),0)),S,V,_),R=De(z,S,V,_),C=De(z.add(new v(M,0)),S,V,_),O=De(z.add(new v(Le(M),M)),S,V,_),E=De(z.add(new v(0,M)),S,V,_),D=De(z.add(new v(M,M)),S,V,_),L=e.textureUV.divide(this.mosaicInfo.size),B=t.textureUVNextVertex1.divide(this.mosaicInfo.size),k=t.textureUVNextVertex2.divide(this.mosaicInfo.size),N={color:new h(1),outlineColor:new h(1),overrideOutlineColor:new p(1),outlineSize:n,distanceToPx:c,isSDF:u};let U=new p(0);return U=U.add(Be(T).multiply(this._getColor(Ti(T,L,B,k),N).a)),U=U.add(Be(P).multiply(this._getColor(Ti(P,L,B,k),N).a)),U=U.add(Be(A).multiply(this._getColor(Ti(A,L,B,k),N).a)),U=U.add(Be(I).multiply(this._getColor(Ti(I,L,B,k),N).a)),U=U.add(Be(R).multiply(this._getColor(Ti(R,L,B,k),N).a)),U=U.add(Be(C).multiply(this._getColor(Ti(C,L,B,k),N).a)),U=U.add(Be(O).multiply(this._getColor(Ti(O,L,B,k),N).a)),U=U.add(Be(E).multiply(this._getColor(Ti(E,L,B,k),N).a)),U=U.add(Be(D).multiply(this._getColor(Ti(D,L,B,k),N).a)),d(U,new p(.05)).multiply(F(this.hittestRequest))}}We([q(ue)],Fi.prototype,"visualVariableColor",void 0),We([q(ce)],Fi.prototype,"visualVariableOpacity",void 0),We([q(bi)],Fi.prototype,"visualVariableRotation",void 0),We([q(pe)],Fi.prototype,"visualVariableSizeMinMaxValue",void 0),We([q(de)],Fi.prototype,"visualVariableSizeScaleStops",void 0),We([q(he)],Fi.prototype,"visualVariableSizeStops",void 0),We([q(fe)],Fi.prototype,"visualVariableSizeUnitValue",void 0),We([s(me)],Fi.prototype,"mosaicInfo",void 0),We([Ge(0,y(zi)),Ge(1,y(Mi))],Fi.prototype,"vertex",null),We([Ge(0,y(class extends w{}))],Fi.prototype,"fragment",null);class Ai{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((([e,t])=>`${e}.${t}`)).join("."),i=Xe(t);this._locationInfo={hash:i,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){const s=Object.keys(i).filter((e=>i[e])).map((e=>`${e}_${i[e].toString()}`)).join("."),r=Object.keys(t).filter((e=>this.optionPropertyKeys.has(e))).join(".");return`${e.hash}.${s}.${r}`}getProgram(e,t,i,s){let r="",o="";for(const a in i)if(i[a]){const e="boolean"==typeof i[a]?`#define ${a}\n`:`#define ${a} ${i[a]}\n`;r+=e,o+=e}return r+=this.vertexShader,o+=this.fragmentShader,new Ne(r,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const e=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:e.type,uniformArrayElementType:Ii(e),uniformArrayLength:Ri(e)})}for(const i in e){const s=this.options[i];if(e[i])for(const e in s){const r=s[e];t.push({uniformHydrated:null,shaderModulePath:`${i}.${e}`,uniformName:e,uniformType:r.type,uniformArrayElementType:Ii(r),uniformArrayLength:Ri(r)})}}return t}}const Ii=e=>"array"===e.type?e.elementType?.type:void 0,Ri=e=>"array"===e.type?e.size:void 0,Ci={hittestDist:p,hittestPos:v},Oi={filterFlags:b,animation:b,visualVariableData:b,dataDriven0:b,dataDriven1:b,dataDriven2:b,gpgpu:b,size:p},Ei={displayViewScreenMat3:n,displayViewMat3:n,displayMat3:n,viewMat3:n,tileMat3:n,displayZoomFactor:p,requiredZoomFactor:p,tileOffset:v,currentScale:p,currentZoom:p,metersPerSRUnit:p};let Di=class extends Ai{constructor(){super(...arguments),this.vertexShader=Wt("materials/pie/pie.vert"),this.fragmentShader=Wt("materials/pie/pie.frag"),this.required={...Oi,...Ei,outlineWidth:p,colors:S,defaultColor:h,othersColor:h,outlineColor:h,donutRatio:p,sectorThreshold:p},this.options={hittestUniforms:Ci,visualVariableSizeMinMaxValue:{minMaxValueAndSize:h},visualVariableSizeScaleStops:{sizes:{...S.ofType(p,8),type:"array",elementType:p,size:8},values:{...S.ofType(p,8),type:"array",elementType:p,size:8}},visualVariableSizeStops:{sizes:{...S.ofType(p,8),type:"array",elementType:p,size:8},values:{...S.ofType(p,8),type:"array",elementType:p,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:p},visualVariableOpacity:{opacities:{...S.ofType(p,8),type:"array",elementType:p,size:8},opacityValues:{...S.ofType(p,8),type:"array",elementType:p,size:8}}},this.locations={pos:{index:0,type:v},id:{index:1,type:l},bitset:{index:2,type:p},offset:{index:3,type:v},texCoords:{index:4,type:v},size:{index:5,type:v},referenceSize:{index:6,type:p},zoomRange:{index:7,type:v}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...S.ofType(h,e),type:"array",elementType:h,size:e}}};const Li=e("h",{fill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.FillMeshWriter,this.shaders={geometry:new A}}render(e,t){const{context:i,painter:s}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target)},defines:mt(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("fill"),patternFill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.PatternFillMeshWriter,this.shaders={geometry:new E}}render(e,t){const{context:i,painter:s}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:gt(t.target)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("patternFill"),complexFill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.ComplexFillMeshWriter,this.shaders={geometry:new R}}render(e,t){const{context:i,painter:s}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:gt(t.target)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("complexFill"),outlineFill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.OutlineFillMeshWriter,this.shaders={geometry:new O}}render(e,t){const{context:i,painter:s,pixelRatio:r}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),antialiasingControls:ii(r)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("outlineFill"),patternOutlineFill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.PatternOutlineFillMeshWriter,this.shaders={geometry:new D}}render(e,t){const{context:i,painter:s,pixelRatio:r}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),antialiasingControls:ii(r),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:gt(t.target)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("patternOutlineFill"),complexOutlineFill:new class extends t{constructor(){super(...arguments),this.meshWriter=I.ComplexOutlineFillMeshWriter,this.shaders={geometry:new C}}render(e,t){const{context:i,painter:s,pixelRatio:r}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),antialiasingControls:ii(r),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:gt(t.target)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("complexOutlineFill"),marker:new class extends t{constructor(){super(...arguments),this.meshWriter=I.MarkerMeshWriter,this.shaders={geometry:new Fi},this.symbologyPlane=pt.MARKER}render(e,t){const{context:i,painter:s}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("marker"),pieChart:new class extends t{constructor(){super(...arguments),this.meshWriter=I.PieChartMeshWriter,this.shaders={geometry:new Di},this.symbologyPlane=pt.MARKER}render(e,t){const{context:i,painter:s}=e,{instance:r,target:o}=t,a=this.shaders.geometry,n=r.getInput(),l=n.numberOfFields,u=ht(e),c=ft(e,o),p=mt(e);a.setNumberOfFields(l),s.setShader({shader:a,uniforms:{...bt(e,t.target,n.geometry),...c.storage,...c.view,hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!n.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!n.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!n.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!n.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!n.geometry.visualVariableOpacity,HITTEST:u,highlight:c.highlight?1:0,...p,numberOfFields:l},optionalAttributes:{},useComputeBuffer:u}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("pieChart"),line:new class extends t{constructor(){super(...arguments),this.meshWriter=I.LineMeshWriter,this.shaders={geometry:new ye},this.symbologyPlane=pt.LINE}render(e,t){const{context:i,painter:s,pixelRatio:r}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),antialiasingControls:ii(r)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("line"),texturedLine:new class extends t{constructor(){super(...arguments),this.meshWriter=I.TexturedLineMeshWriter,this.shaders={geometry:new _i},this.symbologyPlane=pt.LINE}render(e,t){const{context:i,painter:s,pixelRatio:r}=e;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),antialiasingControls:ii(r),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...mt(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}}("texturedLine"),text:new class extends t{constructor(){super(...arguments),this.meshWriter=I.TextMeshWriter,this.shaders={geometry:new Si},this.symbologyPlane=pt.TEXT}render(e,t){const{context:i,painter:s}=e,r=mt(e),o={shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...r,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)};s.setShader(o),s.setPipelineState(yt(e)),s.submitDraw(i,t),s.setShader({...o,defines:{...r,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),s.submitDraw(i,t),s.setShader({...o,defines:{...r,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),s.submitDraw(i,t)}}("text"),label:new class extends t{constructor(){super(...arguments),this.meshWriter=I.LabelMeshWriter,this.shaders={geometry:new Si},this.drawPhase=ct.LABEL|ct.LABEL_ALPHA,this.symbologyPlane=pt.TEXT}render(e,t){const{context:i,painter:s}=e,r=mt(e),o={...yt(e)},a={shader:this.shaders.geometry,uniforms:{...bt(e,t.target,t.instance.getInput().geometry),...ft(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...r,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};s.setShader(a),s.setPipelineState(o),s.submitDraw(i,t),s.setShader({...a,defines:{...r,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(o),s.submitDraw(i,t),s.setShader({...a,defines:{...r,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(o),s.submitDraw(i,t)}}("label"),heatmap:new class extends t{constructor(){super(...arguments),this.meshWriter=I.HeatmapMeshWriter,this.shaders={accumulate:new li,resolve:new di},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=hi}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:r}=e,o=t.instance.getInput(),{isFieldActive:a}=o,n=this._getOrCreateResourcesRecord(i),l=n.loadQualityProfile(i);if(dt(e))return;ht(e)||this._bind(e,n,o),s.setShader({shader:this.shaders.accumulate,uniforms:{...ft(e,t.target),kernelControls:{radius:vi(o,r),isFieldActive:a?1:0}},defines:{...mt(e),...l.defines},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:ht(e)});const u=ht(e)?mi:fi;s.setPipelineState(u),s.submitDraw(i,t)}postProcess(e,t){if(ht(e)||dt(e))return;const{context:i,painter:s}=e,r=this._resources.get(i);if(null==this._prevFBO||null==this._prevViewport||!r?.initialized)return;const{defines:o}=r.loadQualityProfile(i),{minDensity:a,maxDensity:n,radius:l}=t.getInput(),u=r.accumulateFramebuffer,c=r.resolveGradientTexture;s.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:u.colorTexture},minAndInvRange:[a,1/(n-a)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:c}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(u.colorTexture,8),i.bindTexture(c,9),s.setPipelineState(yi),s.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ri,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:r,pixelRatio:o}=e,a=s.getBoundFramebufferObject(),n=s.getViewport();this._prevFBO=a,this._prevViewport=n;const{gradient:l,gradientHash:u}=i;t.ensureResolveGradientTexture(s,u,l);const{width:c,height:p}=n,d=function(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}(vi(i,r),o),h=c*d,f=p*d,m=t.ensureAccumulateFBO(s,h,f);s.blitFramebuffer(a,m,0,0,a.width,a.height,0,0,m.width,m.height,Pt.STENCIL_BUFFER_BIT,Vt.NEAREST),s.bindFramebuffer(m),s.setViewport(0,0,m.width,m.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(Pt.COLOR_BUFFER_BIT),this._isBound=!0}}("heatmap"),dotDensity:new class extends t{constructor(){super(...arguments),this.shaders={polygon:new Yt,point:new $t,fill:new A},this.meshWriter=I.DotDensityMeshWriter,this._resources=new Map}render(e,t){dt(e)||ht(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{context:i,painter:s}=e;s.setShader({shader:this.shaders.fill,uniforms:{...ft(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...mt(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:ht(e)}),s.setPipelineState(yt(e)),s.submitDraw(i,t)}_renderDotDensity(e,t){const{context:i,painter:s,requiredLevel:r}=e,o=t.instance.getInput(),a=this._getOrCreateResourcesRecord(i),n=a.getDotDensityTextures(i,rt,o.seed),l=1/2**(r-t.target.key.level),u=rt,c=u*window.devicePixelRatio*u*window.devicePixelRatio,p=1/l*(1/l),d=o.dotScale?e.state.scale/o.dotScale:1,h=o.dotValue*d*p;s.setShader({shader:this.shaders.polygon,uniforms:{...ft(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,h)},draw:{dotTexture0:{unit:ot,texture:n[0]},dotTexture1:{unit:at,texture:n[1]},tileZoomFactor:l,pixelRatio:window.devicePixelRatio,tileDotsOverArea:c/(rt*window.devicePixelRatio*rt*window.devicePixelRatio)}},defines:{...mt(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),s.setPipelineState(yt(e));const f=i.getViewport();i.setViewport(0,0,rt,rt);const m=i.getBoundFramebufferObject(),y=a.getFBO(i);i.bindFramebuffer(y),i.setClearColor(0,0,0,0),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.updatePipelineState(i),i.clear(Pt.COLOR_BUFFER_BIT),s.submitDraw(i,t),i.bindFramebuffer(m),i.setViewport(f.x,f.y,f.width,f.height);const v=a.getFBO(i).colorTexture;s.setShader({shader:this.shaders.point,uniforms:{view:vt(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:ot,texture:v},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...mt(e)},optionalAttributes:{},useComputeBuffer:!1}),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.submitDrawMesh(i,a.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ti,this._resources.set(e,t)),t}}("dotDensity")});function Bi(e,t){const i=e.slice(0,t),s=t-i.length;for(let r=0;r<s;r++){const e=i[i.length-1];i.push(e)}return i}function ki(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a:r}=e;return[t*(r/255),i*(r/255),s*(r/255),r]}const Ni=8,Ui=Ni-2,Hi=()=>Ke.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Wi(e){return e.map((e=>function(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}(e)?function(e){return e.stops=function(e,t){return t.length<=Ni?t:(Hi().warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${Ni}. Displayed stops will be simplified.`),t.length>2*Ni?function(e,t){const[i,...s]=t,r=s.pop(),o=s[0].value,a=s[s.length-1].value,n=(a-o)/Ui,l=[];for(let u=o;u<a;u+=n){let i=0;for(;u>=s[i].value;)i++;const r=s[i],o=t[i-1],a=u-o.value,n=r.value===o.value?1:a/(r.value-o.value);if("color"===e){const e=s[i],r=t[i-1],o=e.color.clone();o.r=Gi(r.color.r,o.r,n),o.g=Gi(r.color.g,o.g,n),o.b=Gi(r.color.b,o.b,n),o.a=Gi(r.color.a,o.a,n),l.push({value:u,color:o,label:e.label})}else if("size"===e){const e=s[i],r=t[i-1],o=Ze(e.size),a=Gi(Ze(r.size),o,n);l.push({value:u,size:a,label:e.label})}else{const e=s[i],r=Gi(t[i-1].opacity,e.opacity,n);l.push({value:u,opacity:r,label:e.label})}}return[i,...l,r]}(e,t):function(e){const[t,...i]=e,s=i.pop();for(;i.length>Ui;){let e=0,t=0;for(let s=1;s<i.length;s++){const r=i[s-1],o=i[s],a=Math.abs(o.value-r.value);a>t&&(t=a,e=s)}i.splice(e,1)}return[t,...i,s]}(t))}(e.type,e.stops??[]),e}(e.clone()):e))}function Gi(e,t,i){return(1-i)*e+i*t}const ji=1.25,qi=128,$i=128;function Ki(e){if(!e.stops?.length)return null;const t=Bi(e.stops.sort(((e,t)=>e.value-t.value)),8),i=t.map((({value:e})=>e)),s=t.map((({color:e})=>ki(e)));return{values:i,colors:s}}function Xi(e){if(!e.stops?.length)return null;const t=Bi(e.stops.sort(((e,t)=>e.value-t.value)),8);return{opacityValues:t.map((({value:e})=>e)),opacities:t.map((({opacity:e})=>e))}}function Zi(e){return{rotationType:"geographic"===e.rotationType?H.Geographic:H.Arithmatic}}function Yi(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(t,i)=>{const s=t.statisticsByLevel.get(i.key.level),r=e.stops.map((t=>({value:t.useMaxValue?s?.get(e.field)?.maxValue??0:t.useMinValue?s?.get(e.field)?.minValue??0:t.value,size:t.size?Qe(t.size):ut}))).sort(((e,t)=>e.value-t.value)),o=Bi(r,8);return{values:o.map((({value:e})=>e)),sizes:o.map((({size:e})=>e))}};const t=e.stops.sort(((e,t)=>e.value-t.value)),i=Bi(t,8);return{values:i.map((({value:e})=>e)),sizes:i.map((({size:e})=>Qe(e)))}}function Qi(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:Je(i.spatialReference)/et[e.valueUnit]/i.resolution}}}function Ji(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function es(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:r}=e;if("object"==typeof s&&"object"==typeof r)return(e,o)=>{const a=e.state.scale,n=Qe(Ji(a,s.stops)),l=Qe(Ji(a,r.stops));return{minMaxValueAndSize:[t,i,n,l]}};if("object"==typeof s||"object"==typeof r)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,Qe(s),Qe(r)]}}const ts=e("x",{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null});function is(e,t=$i,i=ji){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?qi:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return qi;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return qi;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?2*qi:0}function ss(e){if("number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize)return"min-max";if((e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops))return"scale-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels))return"field-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function rs(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function os(e){if(null==e)return null;if(Array.isArray(e)){const[t,i,s,r]=e;return[t,i,s,255*r]}return"string"==typeof e?e:{...e,defaultValue:os(e?.defaultValue)}}function as(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function ns(e,t,i){const{uniforms:s,schemaOptions:r}=t,{store:o}=r,a=e.isOutline?{...ts,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};return ls(o.ensureInstance(Li.marker,{geometry:a},{zoomRange:!!i.scaleInfo}),e,s,i)}function ls(e,t,i,{scaleInfo:s,scaleExpression:r}){const o=as(i);return[e.createMeshInfo({params:{size:t.size,scaleX:t.scaleX,anchorX:t.anchorPoint.x,anchorY:t.anchorPoint.y,angle:t.rotation,color:os(t.color)??[0,0,0,0],colorLocked:t.colorLocked,frameHeight:t.frameHeight,widthRatio:t.widthRatio,scaleInfo:s,offsetX:t.offsetX,offsetY:t.offsetY,outlineColor:os(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineWidth,referenceSize:t.referenceSize||tt.CIMVectorMarker.size,rotateClockwise:t.rotateClockwise,scaleFactor:r??1,sizeRatio:t.sizeRatio,alignment:t.alignment,isAbsoluteAnchorPoint:t.isAbsoluteAnchorPoint,scaleSymbolsProportionally:t.scaleSymbolsProportionally,sprite:t.spriteRasterizationParam,hasSizeVV:o,placement:t.markerPlacement,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,transforms:t.transform,minPixelBuffer:is(i)}})]}function us(e,t,{scaleInfo:i}){return[e.createMeshInfo({params:{color:os(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}})]}function cs(e,t,i){if(!e.spriteRasterizationParam)return function(e,t,i){const{uniforms:s,schemaOptions:r}=t,{store:o}=r;return us(o.ensureInstance(Li.fill,{geometry:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity}},{zoomRange:!!i.scaleInfo}),e,i)}(e,t,i);const{uniforms:s,schemaOptions:r}=t,{store:o}=r;return ps(o.ensureInstance(Li.complexFill,{geometry:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity}},{zoomRange:!!i.scaleInfo}),e,null!=s.visualVariableColor,i)}function ps(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const r=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),o=t.sampleAlphaOnly&&!r,a=t.spriteRasterizationParam;return[e.createMeshInfo({params:{color:os(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:"CIMHatchFill"===a.resource.type,sprite:a,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}})]}function ds(e,t,i){const{uniforms:s,schemaOptions:r}=t,{store:o}=r,a=e.isOutline?{...ts,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},n={geometry:a},l=!!(a.visualVariableSizeMinMaxValue||a.visualVariableSizeScaleStops||a.visualVariableSizeStops||a.visualVariableSizeUnitValue);return e.spriteRasterizationParam?ms(o.ensureInstance(Li.texturedLine,n,{zoomRange:!!i.scaleInfo}),e,l,i):fs(o.ensureInstance(Li.line,n,{zoomRange:!!i.scaleInfo}),e,l,i)}function hs(e,t,{scaleInfo:i}){return{params:{color:os(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}}function fs(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[e.createMeshInfo({params:hs(t,i,s).params})]}function ms(e,t,i,s){const{spriteRasterizationParam:r,scaleDash:o,sampleAlphaOnly:a}=t;if(!r)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({params:{...hs(t,i,s).params,shouldScaleDash:o??!1,shouldSampleAlphaOnly:a,isSDF:"CIMPictureStroke"!==r.resource.type,sprite:r}})]}function ys(e,t,i){const{uniforms:s,schemaOptions:r}=t,{store:o}=r;return vs(o.ensureInstance(Li.text,{geometry:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue}},{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1}),e,s,i)}function vs(e,t,i,{scaleInfo:s,scaleExpression:r}){return[e.createMeshInfo({params:{boxBackgroundColor:os(t.backgroundColor),boxBorderLineColor:os(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:os(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:os(t.outlineColor)??[0,0,0,0],haloFontSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:r??1,minPixelBuffer:is(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function bs(e){switch(e){case"opacity":return xt.OPACITY;case"color":return xt.COLOR;case"rotation":return xt.ROTATION;case"size":return xt.SIZE;default:return null}}function gs(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return xs(e);case"dot-density":return function(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}(e);case"pie-chart":return function(e){const t=xs(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}(e);case"heatmap":return function({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}(e)}}function xs(e){return"visualVariables"in e&&e.visualVariables?.length?Wi(e.visualVariables).map((e=>function(e){switch(e.type){case"size":return function(e){return"$view.scale"===e.valueExpression?null:{binding:bs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}(e);case"color":case"opacity":return function(e){return{binding:bs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}(e);case"rotation":return function(e){return{binding:bs(e.type),expression:e.valueExpression,field:e.field}}(e)}}(e))).filter(it):[]}function ws(e){return e.some((e=>e.globalId))}function Ss(e){return e.filter((e=>!e.error)).map((e=>e.objectId??e.globalId)).filter((e=>null!=e))}function Vs(e,t){const i=new Set(e);for(const s of t.values())i.add(s);return i}function _s(e,t){const i=new Set(e);for(const s of t.values())i.delete(s);return i}e("b",class{constructor(e){this.updateTracking=new He({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new st({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return this.updateTracking.addPromise(this._doPush(e))}async _doPush(e){const t=this._queueProcessor,i=t.last(),s=[];switch(e.type){case"update":if(i?.type===e.type)return;s.push(t.push(e));break;case"edit":{const r="processed-edit"===i?.type?i:null;r&&t.popLast();const o=this._mergeEdits(r,e);for(const e of o)e&&s.push(t.push(e));break}}await Promise.all(s)}_mergeEdits(e,t){const{addedFeatures:i,deletedFeatures:s,updatedFeatures:r}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||ws(i)||ws(r)||ws(s),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...i,...r],removed:s}}];const o=new Set(Ss(e?.edits.addOrModified??[])),a=new Set(Ss(e?.edits.removed??[])),n=new Set([...Ss(i),...Ss(r)]),l=new Set(Ss(s));return[{type:"processed-edit",edits:{addOrModified:Array.from(Vs(_s(o,l),n)).map((e=>({objectId:e}))),removed:Array.from(Vs(_s(a,n),l)).map((e=>({objectId:e})))}}]}})}}}));
