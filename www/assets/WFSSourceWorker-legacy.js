System.register(["./index-legacy.js","./featureConversionUtils-legacy.js","./FeatureStore-legacy.js","./timeSupport-legacy.js","./QueryEngine-legacy.js","./geojson-legacy.js","./sourceUtils-legacy.js","./wfsUtils-legacy.js","./OptimizedGeometry-legacy.js","./OptimizedFeatureSet-legacy.js","./BoundsStore-legacy.js","./PooledRBush-legacy.js","./json-legacy.js","./WhereClause-legacy.js","./TimeOnly-legacy.js","./QueryEngineCapabilities-legacy.js","./utils-legacy4.js","./utils-legacy3.js","./utils-legacy5.js","./ClassBreaksDefinition-legacy.js","./RenderState-legacy.js","./date-legacy.js","./xmlUtils-legacy.js"],(function(e,t){"use strict";var a,s,r,n,o,i,u,l,c,h,y,g,p,m,d,_,f,x,C,w,R;return{setters:[e=>{a=e.s,s=e.at,r=e.cx,n=e.aZ,o=e.cB,i=e.w,u=e.cX,l=e.o,c=e.G},e=>{h=e.o,y=e.r},e=>{g=e.m},e=>{p=e.x,m=e.j},e=>{d=e.$},e=>{_=e.E,f=e.N},e=>{x=e.p},e=>{C=e.o,w=e.e,R=e.K},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){const t="esri.layers.WFSLayer";function F(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:"wfs-layer:maxRecordCount-too-low",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:"wfs-layer:large-dataset",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}e("default",class{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t={}){const{getFeatureUrl:o,getFeatureOutputFormat:i,fields:u,geometryType:l,featureType:c,maxRecordCount:h,maxTotalRecordCount:y,maxPageCount:m,objectIdField:_,customParameters:f}=e,{spatialReference:x,getFeatureSpatialReference:w}=C(o,c,e.spatialReference);try{await p(w,x)}catch{throw new a("unsupported-projection","Projection not supported",{inSpatialReference:w,outSpatialReference:x})}s(t),this._customParameters=f,this._featureType=c,this._fieldsIndex=r.fromLayerJSON({fields:u,dateFieldsTimeReference:u.some((e=>"esriFieldTypeDate"===e.type))?{timeZoneIANA:n}:null}),this._geometryType=l,this._getFeatureUrl=o,this._getFeatureOutputFormat=i,this._getFeatureSpatialReference=w,this._maxRecordCount=h,this._maxTotalRecordCount=y,this._maxPageCount=m,this._objectIdField=_,this._spatialReference=x;let R=await this._snapshotFeatures(t);if(R.errors.length>0&&(this._supportsPagination=!1,R=await this._snapshotFeatures(t),R.errors.length>0))throw R.errors[0];return this._queryEngine=new d({fieldsIndex:this._fieldsIndex,geometryType:l,hasM:!1,hasZ:!1,objectIdField:_,spatialReference:x,timeInfo:null,featureStore:new g({geometryType:l,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(R.features),{warnings:F(R),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new a("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(e){return this._customParameters=e.customParameters,this._maxRecordCount=e.maxRecordCount,this._maxTotalRecordCount=e.maxTotalRecordCount,this._maxPageCount=e.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=o((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const a of F(e))i.getLogger(t).warn(new u("wfs-layer:refresh-warning",a.message,a.details));e.errors?.length&&i.getLogger(t).warn(new u("wfs-layer:refresh-error","Refresh completed with errors",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const t=e?.signal,a=this._maxTotalRecordCount,r=this._maxPageCount,n=this._supportsPagination?await w(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0;let o=[];const i=[];if(null==n)try{o=await this._singleQuery(t)}catch(u){l(u)||i.push(u)}else{const e=Math.min(n,a),s=function*(e,t,a){for(let s=0;s<t;s++)yield e._pageQuery(s,a)}(this,Math.max(1,Math.min(Math.ceil(e/this._maxRecordCount),r)),t);await Promise.allSettled(Array.from({length:10}).map((()=>async function(e,t,a){let s=e.next();for(;!s.done;){try{const e=await s.value;t.push(...e)}catch(r){l(r)||a.push(r)}s=e.next()}}(s,o,i))))}return s(t),{features:o,totalRecordCount:n,maxTotalRecordCount:a,maxPageCount:r,errors:i}}async _singleQuery(e){const t=await R(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:e});return this._processGeoJSON(t,{signal:e})}async _pageQuery(e,t){const a=e*this._maxRecordCount,s=await R(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:a,count:this._maxRecordCount,signal:t});return this._processGeoJSON(s,{startIndex:a,signal:t})}_processGeoJSON(e,t){_(e,this._getFeatureSpatialReference.wkid);const{startIndex:a,signal:r}=t;s(r);const n=f(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!c(this._spatialReference,this._getFeatureSpatialReference))for(const s of n)null!=s.geometry&&(s.geometry=h(m(y(s.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let o=a??1;for(const s of n){const e={};x(this._fieldsIndex,e,s.attributes,!0),s.attributes=e,null==e[this._objectIdField]&&(s.objectId=e[this._objectIdField]=o++)}return n}})}}}));
