System.register(["./index-legacy.js","./arcadeUtils-legacy.js","./portalUtils-legacy.js","./GraphQueryStreaming-legacy.js","./TimeOnly-legacy.js","./ImmutableArray-legacy.js","./number-legacy.js","./featureConversionUtils-legacy.js","./OptimizedGeometry-legacy.js","./OptimizedFeatureSet-legacy.js"],(function(e,n){"use strict";var t,r,a,i,o,l,s,c,u,f,p,d,g,h,m,y,w,S,v,b,R,j,x,G,k,I,W,T,P,q,D,F,N,U,A,J,O;return{setters:[e=>{t=e.an,r=e._,a=e.ap,i=e.b2,o=e.b3,l=e.b4,s=e.bc,c=e.d5,u=e.d6,f=e.am,p=e.ei,d=e.ek,g=e.el},e=>{h=e.a,m=e.b,y=e.r,w=e.x,S=e.d,v=e.G,b=e.a9,R=e.v,j=e.N,x=e.U,G=e.q,k=e.E,I=e.X,W=e.k,T=e.t,P=e.aa,q=e.ab,D=e.ac},e=>{F=e.l},e=>{N=e.a,U=e.m,A=e.t,J=e.p,O=e.c},null,null,null,null,null,null],execute:function(){e("registerFunctions",(function(e){"async"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(n,r){return e.standardFunctionAsync(n,r,((e,a,i)=>{if(h(i,2,2,n,r),null===i[0])throw new m(n,y.PortalRequired,r);if(i[0]instanceof w){const e=S(i[1]);let r=null;return r=n.services?.portal?n.services.portal:t.getDefault(),z(F(i[0],r),e)}if(!1===v(i[0]))throw new m(n,y.InvalidParameter,r);const o=S(i[0]);return z(n.services?.portal??t.getDefault(),o)}))},e.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),e.functions.querygraph=function(t,f){return e.standardFunctionAsync(t,f,(async(e,p,g)=>{h(g,2,4,t,f);const w=g[0];if(!b(w))throw new m(t,y.InvalidParameter,f);const S=g[1];if(!v(S))throw new m(t,y.InvalidParameter,f);null===Q&&(Q=await r((()=>n.import("./knowledgeGraphService-legacy.js").then((e=>e.k))),void 0,n.meta.url));let k=null;const I=R(g[2],null);if(!(I instanceof j||null===I))throw new m(t,y.InvalidParameter,f);if(I){let e=[];k=C(I,!0,!1,t,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await async function(e){const n=a.geometryServiceUrl??"";if(!n){i()||await o();for(const n of e)n.container[n.indexer]=l(n.container[n.indexer],s.WGS84);return}const t=e.map((e=>e.container[e.indexer])),r=new c({geometries:t,outSpatialReference:s.WGS84}),f=await u(n,r);for(let a=0;a<f.length;a++){const n=e[a];n.container[n.indexer]=f[a]}}(e)}const W=new N({openCypherQuery:S,bindParameters:k});(w?.serviceDefinition?.currentVersion??11.3)>11.2&&(W.outputSpatialReference=t.spatialReference);const T=(await Q.executeQueryStreaming(w,W)).resultRowsStream.getReader(),P=[];try{for(;;){const{done:e,value:n}=await T.read();if(e)break;if(x(n))for(const r of n)P.push(K(r,t));else{const e=[];for(const r of n)e.push(K(n[r],t));P.push(e)}}}catch(d){throw d}return j.convertJsonToArcade(P,G(t),!1,!0)}))},e.signatures.push({name:"querygraph",min:2,max:4}))}));let Q=null;async function z(e,t){const a=new f({portal:e,id:t});return await a.load(),null===Q&&(Q=await r((()=>n.import("./knowledgeGraphService-legacy.js").then((e=>e.k))),void 0,n.meta.url)),await Q.fetchKnowledgeGraph(a.url)}function C(e,n,t,r,a){if(null===e)return null;if(v(e)||k(e))return e;if(I(e))return e.toJSDate();if(I(e))return e.toJSDate();if(W(e))return e.toStorageFormat();if(T(e))return e.toStorageString();if(P(e)){const i={};for(const o of e.keys())i[o]=C(e.field(o),n,t,r,a),i[o]instanceof p&&a.push({container:i,indexer:o});return i}if(x(e)){const i=e.map((e=>C(e,n,t,r,a)));for(let e=0;e<i.length;e++)i[e]instanceof p&&a.push({container:i,indexer:e});return i}if(q(e)){if(e.spatialReference.isWGS84)return e;if(e.spatialReference.isWebMercator&&n)return d(e);if(!n||!t)return e;throw new m(r,y.WrongSpatialReference,null)}}function M(e,n){if(!e)return e;if(e.spatialReference.isWGS84&&n.spatialReference.isWebMercator)return g(e);if(e.spatialReference.equals(n.spatialReference))return e;throw new m(n,y.WrongSpatialReference,null)}function E(e,n){if(!e)return null;const t={};for(const r in e)t[r]=K(e[r],n);return t}function K(e,n){return null===e?null:x(e)?e.map((e=>K(e,n))):e instanceof U?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:E(e.properties,n)}:e instanceof A?{graphType:"object",properties:E(e.properties,n)}:e instanceof J?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:E(e.properties,n)}:e instanceof O?{graphType:"path",path:e.path?e.path.map((e=>K(e,n))):null}:q(e)?M(e,n):v(e)||k(e)||D(e)?e:null}}}}));
