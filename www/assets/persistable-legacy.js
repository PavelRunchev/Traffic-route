System.register(["./index-legacy.js","./multiOriginJSONSupportUtils-legacy.js","./resourceExtension-legacy.js"],(function(e,t){"use strict";var r,o,s,n,i,c,u,p,a,d,l,f,y,m,g,h,v,U,w;return{setters:[e=>{r=e.dq,o=e.dr,s=e.ds,n=e.dt,i=e.du,c=e.dv,u=e.dw,p=e.dx,a=e.dy,d=e.dz,l=e.s,f=e.dA,y=e.d7,m=e.bG,g=e.dB,h=e.bH,v=e.dC},e=>{U=e.i},e=>{w=e.p}],execute:function(){function t(e,t,r){const d=o(t,r);return{type:String,read:(e,t,r)=>{const o=s(e,t,r);return d.type===String?o:"function"==typeof d.type?new d.type({url:o}):void 0},write:{writer(t,o,s,l){if(!l?.resources)return"string"==typeof t?void(o[s]=n(t,l)):void(o[s]=t.write({},l));const f=function(e){return null==e?null:"string"==typeof e?e:e.url}(t),y=n(f,{...l,verifyItemRelativeUrls:l?.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},i.NO),m=d.type!==String&&(!U(this)||l?.origin&&this.originIdOf(r)>c(l.origin)),g={object:this,propertyName:r,value:t,targetUrl:y,dest:o,targetPropertyName:s,context:l,params:e};l?.portalItem&&y&&!u(y)?m&&e?.contentAddressed?j(g):m?function(e){const{context:t,targetUrl:r,params:o,value:s,dest:n,targetPropertyName:i}=e;if(!t.portalItem)return;const c=t.portalItem.resourceFromPath(r),u=x(s,r,t),p=w(u),a=h(c.path),d=o?.compress??!1;p===a?(t.resources&&I({...e,resource:c,content:u,compress:d,updates:t.resources.toUpdate}),n[i]=r):j(e)}(g):function({context:e,targetUrl:t,dest:r,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),r[o]=t)}(g):l?.portalItem&&(null==y||null!=p(y)||a(y)||m)?j(g):o[s]=y}}}}function j(e){const{targetUrl:t,params:r,value:o,context:s,dest:n,targetPropertyName:i}=e;if(!s.portalItem)return;const c=d(t),u=x(o,t,s);if(r?.contentAddressed&&"json"!==u.type)return void s.messages?.push(new l("persistable:contentAddressingUnsupported",`Property "${i}" is trying to serializing a resource with content of type ${u.type} with content addressing. Content addressing is only supported for json resources.`,{content:u}));const p=r?.contentAddressed&&"json"===u.type?f(u.jsonString):c?.filename??y(),h=m(r?.prefix??c?.prefix,p),v=`${h}.${w(u)}`;if(r?.contentAddressed&&s.resources&&"json"===u.type){const e=s.resources.toKeep.find((({resource:e})=>e.path===v))??s.resources.toAdd.find((({resource:e})=>e.path===v));if(e)return void(n[i]=e.resource.itemRelativeUrl)}const U=s.portalItem.resourceFromPath(v);a(t)&&s.resources&&s.resources.pendingOperations.push(g(t).then((e=>{U.path=`${h}.${w({type:"blob",blob:e})}`,n[i]=U.itemRelativeUrl})).catch((()=>{})));const j=r?.compress??!1;s.resources&&I({...e,resource:U,content:u,compress:j,updates:s.resources.toAdd}),n[i]=U.itemRelativeUrl}function I({object:e,propertyName:t,updates:r,resource:o,content:s,compress:n}){r.push({resource:o,content:s,compress:n,finish:r=>{!function(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}(e,t,r)}})}function x(e,t,r){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(r))}}e("j",(function(e){const o=e?.origins??[void 0];return(s,n)=>{const i=function(e,r,o){if("resource"===e?.type)return t(e,r,o);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=v;return{read:e,write:t}}}}(e,s,n);for(const e of o){const t=r(s,e,n);for(const e in i)t[e]=i[e]}}}))}}}));
